<!-- Arquivo: templates/login.html | Objetivo: autenticacao e gestao basica de usuarios -->
<!DOCTYPE html>
<html lang="pt-br">
<head>
 <meta charset="UTF-8">
 <title>Entrar - Controle de Processos</title>
 <meta name="viewport" content="width=device-width, initial-scale=1">
 <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
 <link href="{{ url_for('static', filename='css/global.css') }}" rel="stylesheet">
</head>
<body class="bg-light">
<div class="container py-5">
 {% with mensagens = get_flashed_messages(with_categories=True) %}
 {% if mensagens %}
 <div class="row justify-content-center mb-3">
 <div class="col-12 col-xl-7">
 {% for categoria, mensagem in mensagens %}
 <div class="alert alert-{{ categoria }} alert-dismissible fade show" role="alert">
 {{ mensagem }}
 <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
 </div>
 {% endfor %}
 </div>
 </div>
 {% endif %}
 {% endwith %}

 {% if current_user.is_authenticated %}
 <div class="row justify-content-center mb-3">
 <div class="col-12 col-xl-7 d-flex justify-content-end">
 <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('index') }}">Voltar para página inicial</a>
 </div>
 </div>
 {% endif %}

 {% if not current_user.is_authenticated %}
 <div class="row justify-content-center">
 <div class="col-md-6 col-lg-4">
 <div class="card shadow-sm border-0">
 <div class="card-body p-4">
 <h1 class="h4 text-center mb-4">Entrar</h1>
 <form method="post">
 <input type="hidden" name="form_action" value="login">
 <div class="mb-3">
 <label class="form-label" for="username">Usuário ou e-mail</label>
 <input class="form-control" type="text" id="username" name="username" required autofocus>
 </div>
 <div class="mb-3">
 <label class="form-label" for="password">Senha</label>
 <input class="form-control" type="password" id="password" name="password" required>
 </div>
 <div class="form-check mb-3">
 <input class="form-check-input" type="checkbox" id="remember" name="remember">
 <label class="form-check-label" for="remember">Manter-me conectado</label>
 </div>
 <div class="d-grid">
 <button class="btn btn-primary" type="submit">Entrar</button>
 </div>
 </form>
 <div class="text-center mt-3">
 <a href="{{ url_for('index') }}">Voltar ao painel</a>
 </div>
 </div>
 </div>
 </div>
 </div>
 {% endif %}

 {% if current_user.is_authenticated and pode_registrar %}
 <div class="row justify-content-center g-4">
 <div class="col-12 col-xl-7">
 <div class="card shadow-sm border-0">
 <div class="card-body p-4">
 <h2 class="h5 mb-1">Cadastrar novo usuário</h2>
 <p class="text-muted small mb-0">Disponível para assessoria, gerentes e o administrador principal.</p>
 <p class="text-muted small">Informe os dados abaixo e compartilhe a senha temporária gerada automaticamente.</p>
 <form method="post" class="mt-2" id="form-cadastro-usuario">
 <input type="hidden" name="form_action" value="register">
 <input type="hidden" name="adicionar_atribuido_sei" id="adicionar-atribuido-sei" value="0">
 <div class="mb-3">
 <label class="form-label">Gerência vinculada (atribuída) (opcional)</label>
 {% if gerencia_forcada %}
 <input class="form-control" type="text" value="{{ gerencia_padrao_usuario or '' }}" readonly>
 <input type="hidden" name="gerencia_padrao" id="cadastro-gerencia" value="{{ gerencia_padrao_usuario or '' }}">
 {% else %}
 <select class="form-select" name="gerencia_padrao" id="cadastro-gerencia">
 <option value="">Selecione</option>
 {% for g in gerencias %}
 <option value="{{ g }}">{{ g }}</option>
 {% endfor %}
 </select>
 {% endif %}
 </div>
 <div class="mb-3">
 <label class="form-label">Nome completo</label>
 <input class="form-control" type="text" name="nome" id="cadastro-nome" list="nomes-por-gerencia" required>
 <datalist id="nomes-por-gerencia"></datalist>
 </div>
 <div class="mb-3">
 <label class="form-label">E-mail</label>
 <input class="form-control" type="email" name="email" id="cadastro-email" required>
 </div>
 <div class="mb-3">
 <label class="form-label">Gerências liberadas</label>
 <select class="form-select" name="gerencias_liberadas" multiple required size="6">
 {% for g in gerencias %}
 <option value="{{ g }}">{{ g }}</option>
 {% endfor %}
 </select>
 <div class="form-text">Use Ctrl (ou Command no Mac) para selecionar uma ou mais gerências.</div>
 </div>
 <div class="mb-3">
 <label class="form-label">Coordenadoria</label>
 <select class="form-select js-coord-select" id="cadastro-coord" name="coordenadoria" data-target="#cadastro-equipe">
 <option value="">Selecione (opcional)</option>
 {% for item in coordenadorias_cadastro %}
 <option value="{{ item }}">{{ item }}</option>
 {% endfor %}
 </select>
 </div>
 <div class="mb-3">
 <label class="form-label">Equipe / Setor</label>
 <select class="form-select js-equipe-select" id="cadastro-equipe" name="equipe_area">
 <option value="">Selecione (opcional)</option>
 {% for item in equipes_cadastro %}
 <option value="{{ item }}">{{ item }}</option>
 {% endfor %}
 </select>
 </div>
 <div id="status-usuario-existente" class="alert alert-warning py-2 px-3 small d-none mb-3" role="alert"></div>
 </div>
 <div class="mb-3">
 <label class="form-label">Perfil de acesso</label>
 <select class="form-select js-perfil-select" id="cadastro-perfil" name="perfil" data-target="#wrapper-pode-finalizar-cadastro">
 {% for value, label in perfis_disponiveis %}
 <option value="{{ value }}" {% if value == "usuario" %}selected{% endif %}>{{ label }}</option>
 {% endfor %}
 </select>
 </div>
 <div class="mb-3 form-check" id="wrapper-pode-finalizar-cadastro">
 <input class="form-check-input" type="checkbox" id="pode_finalizar_gerencia" name="pode_finalizar_gerencia" value="1" checked>
 <label class="form-check-label" for="pode_finalizar_gerencia">
 Permitir finalizar processos na gerência
 </label>
 <div class="form-text">Desmarcado: usuário pode apenas visualizar, editar e salvar.</div>
 </div>
 <div class="mb-3">
 <label class="form-label">O que cada perfil pode fazer</label>
 <div class="small text-muted">
 <p class="mb-1"><strong>Usuário:</strong> visualiza processos de todas as gerências e pode editar/dar segmento apenas nas gerências liberadas.</p>
 <p class="mb-1"><strong>Assessoria:</strong> tudo do Usuário + cadastra processos, exporta relatórios por gerência e cria campos extras nas gerências liberadas.</p>
 <p class="mb-1"><strong>Gerente:</strong> tudo do Usuário + mesmas permissões da Assessoria nas gerências liberadas e pode cadastrar usuários da própria gerência.</p>
 <p class="mb-0"><strong>Acesso total:</strong> perfil especial com acesso geral ao sistema, disponível apenas para o administrador principal.</p>
 </div>
 </div>
 <div class="d-grid">
 <button class="btn btn-outline-primary" type="submit">Gerar acesso</button>
 </div>
 </form>
 {% if criacao_usuario %}
 <div class="alert alert-info mt-3 mb-0">
 <p class="mb-1 fw-semibold">Credenciais temporárias</p>
 <p class="mb-1 small">Usuário: {{ criacao_usuario.username }}</p>
 <p class="mb-0 small">Senha: <code>{{ criacao_usuario.senha }}</code></p>
 </div>
 {% endif %}
 </div>
 </div>

 {% if pode_gerenciar_usuarios %}
 <div class="card shadow-sm border-0 mt-4">
 <div class="card-body p-4">
 <h2 class="h5 mb-1">Gerenciar usuários</h2>
 <p class="text-muted small">Edite dados, gerências e perfil de acesso. Excluir continua disponível nesta seção.</p>
 {% if usuarios_para_gerenciar %}
 <div class="mb-3">
 <label class="form-label small" for="filtro-usuarios">Pesquisar usuário</label>
 <input
 class="form-control form-control-sm"
 type="text"
 id="filtro-usuarios"
 placeholder="Digite nome, usuário ou e-mail"
 autocomplete="off"
 >
 </div>
 <div class="list-group list-group-flush">
 {% for usuario in usuarios_para_gerenciar %}
 <div
 class="list-group-item px-0"
 data-usuario-filtro="{{ (usuario.nome or usuario.username or '')|lower }} {{ (usuario.username or '')|lower }} {{ (usuario.email or '')|lower }}"
 >
 <div class="d-flex justify-content-between align-items-start gap-2">
 <div class="small">
 <div class="fw-semibold">{{ usuario.nome or usuario.username }}</div>
 </div>
 <div class="d-flex gap-2">
 <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#editarUsuario{{ usuario.id }}" aria-expanded="false">Editar</button>
 {% if usuario.id != current_user.id %}
 <form method="post" action="{{ url_for('excluir_usuario', usuario_id=usuario.id) }}" onsubmit="return confirm('Excluir este usuário?');">
 <button class="btn btn-sm btn-outline-danger" type="submit">Excluir</button>
 </form>
 {% endif %}
 </div>
 </div>
 <div class="collapse mt-3" id="editarUsuario{{ usuario.id }}">
 <form method="post" class="row g-2">
 <input type="hidden" name="form_action" value="update_user">
 <input type="hidden" name="usuario_id" value="{{ usuario.id }}">
 <div class="col-md-6">
 <label class="form-label small">Nome</label>
 <input class="form-control form-control-sm" type="text" name="nome" value="{{ usuario.nome }}" required>
 </div>
 <div class="col-md-6">
 <label class="form-label small">E-mail</label>
 <input class="form-control form-control-sm" type="email" name="email" value="{{ usuario.email }}" required>
 </div>
 <div class="col-12">
 <label class="form-label small">Gerência vinculada (atribuída) (opcional)</label>
 <select class="form-select form-select-sm" name="gerencia_padrao">
 <option value="">Selecione</option>
 {% for g in gerencias %}
 <option value="{{ g }}" {% if g == usuario.gerencia_padrao %}selected{% endif %}>{{ g }}</option>
 {% endfor %}
 </select>
 </div>
 <div class="col-12">
 <label class="form-label small">Gerências liberadas</label>
 <select class="form-select form-select-sm" name="gerencias_liberadas" multiple required size="6">
 {% for g in gerencias %}
 <option value="{{ g }}" {% if g in usuario.gerencias %}selected{% endif %}>{{ g }}</option>
 {% endfor %}
 </select>
 </div>
 <div class="col-md-6">
 <label class="form-label small">Coordenadoria</label>
 <select
 class="form-select form-select-sm js-coord-select"
 name="coordenadoria"
 data-target="#equipeUsuario{{ usuario.id }}"
 >
 <option value="">Selecione (opcional)</option>
 {% for item in coordenadorias_cadastro %}
 <option value="{{ item }}" {% if item == usuario.coordenadoria %}selected{% endif %}>{{ item }}</option>
 {% endfor %}
 </select>
 </div>
 <div class="col-md-6">
 <label class="form-label small">Equipe / Setor</label>
 <select class="form-select form-select-sm js-equipe-select" id="equipeUsuario{{ usuario.id }}" name="equipe_area">
 <option value="">Selecione (opcional)</option>
 {% for item in equipes_cadastro %}
 <option value="{{ item }}" {% if item == usuario.equipe_area %}selected{% endif %}>{{ item }}</option>
 {% endfor %}
 </select>
 </div>
 <div class="col-md-6">
 <label class="form-label small">Perfil</label>
 <select class="form-select form-select-sm js-perfil-select" name="perfil" data-target="#wrapper-pode-finalizar-{{ usuario.id }}">
 {% for value, label in perfis_disponiveis %}
 <option value="{{ value }}" {% if value == usuario.perfil %}selected{% endif %}>{{ label }}</option>
 {% endfor %}
 </select>
 </div>
 <div class="col-md-6 d-flex align-items-end" id="wrapper-pode-finalizar-{{ usuario.id }}">
 <div class="form-check mb-2">
 <input
 class="form-check-input"
 type="checkbox"
 id="podeFinalizar{{ usuario.id }}"
 name="pode_finalizar_gerencia"
 value="1"
 {% if usuario.pode_finalizar_gerencia %}checked{% endif %}
 >
 <label class="form-check-label small" for="podeFinalizar{{ usuario.id }}">
 Permitir finalizar na gerência
 </label>
 </div>
 </div>
 <div class="col-md-6 d-grid align-content-end">
 <button class="btn btn-sm btn-primary mt-4" type="submit">Salvar alterações</button>
 </div>
 </form>
 </div>
 </div>
 {% endfor %}
 </div>
 {% else %}
 <p class="text-muted small mb-0">Nenhum outro usuário cadastrado.</p>
 {% endif %}
 </div>
 </div>
 {% endif %}
 </div>
 </div>
 {% endif %}

 {% if current_user.is_authenticated and not pode_registrar %}
 <div class="row justify-content-center">
 <div class="col-md-8 col-lg-6">
 <div class="card shadow-sm border-0">
 <div class="card-body p-4 text-center">
 <h2 class="h5 mb-2">Cadastro de usuários indisponível</h2>
 <p class="text-muted mb-4">
 Seu perfil não possui permissão para cadastrar ou gerenciar usuários.
 </p>
 <div class="d-flex justify-content-center gap-2 flex-wrap">
 <a class="btn btn-primary" href="{{ url_for('index') }}">Voltar ao painel</a>
 <a class="btn btn-outline-secondary" href="{{ url_for('perfil') }}">Meu perfil</a>
 </div>
 </div>
 </div>
 </div>
 </div>
 {% endif %}
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
(() => {
 const equipesPorCoord = {{ equipes_por_coordenadoria_cadastro|tojson }};
 const coordenadoriasPorGerencia = {{ coordenadorias_por_gerencia_cadastro|tojson }};
 const pessoasPorGerencia = {{ pessoas_por_gerencia_cadastro|tojson }};
 const usuariosExistentes = {{ usuarios_existentes|tojson }};

 const inputFiltro = document.getElementById("filtro-usuarios");
 if (inputFiltro) {
 const itens = Array.from(document.querySelectorAll("[data-usuario-filtro]"));
 const aplicarFiltro = () => {
 const termo = (inputFiltro.value || "").toLowerCase().trim();
 itens.forEach((item) => {
 const texto = (item.getAttribute("data-usuario-filtro") || "").toLowerCase();
 const visivel = !termo || texto.includes(termo);
 item.style.display = visivel ? "" : "none";
 });
 };
 inputFiltro.addEventListener("input", aplicarFiltro);
 }

 const normalizar = (valor) => (valor || "").trim().toLowerCase();

 const popularOpcoesSelect = (selectEl, lista, placeholder) => {
 if (!selectEl) return;
 const atual = selectEl.value || "";
 selectEl.innerHTML = "";
 const opInicial = document.createElement("option");
 opInicial.value = "";
 opInicial.textContent = placeholder;
 selectEl.appendChild(opInicial);
 (lista || []).forEach((item) => {
 const opt = document.createElement("option");
 opt.value = item;
 opt.textContent = item;
 if (item === atual) opt.selected = true;
 selectEl.appendChild(opt);
 });
 if (atual && !(lista || []).includes(atual)) {
 const optAtual = document.createElement("option");
 optAtual.value = atual;
 optAtual.textContent = `${atual} (atual)`;
 optAtual.selected = true;
 selectEl.appendChild(optAtual);
 }
 };

 const preencherEquipes = (coordSelect, equipeSelect) => {
 if (!coordSelect || !equipeSelect) return;
 const coord = coordSelect.value || "";
 const lista = (coord && equipesPorCoord[coord]) ? equipesPorCoord[coord] : [];
 popularOpcoesSelect(equipeSelect, lista, "Selecione (opcional)");
 };

 document.querySelectorAll(".js-coord-select").forEach((coordSelect) => {
 if (coordSelect.id === "cadastro-coord") return;
 const target = coordSelect.dataset.target || "";
 const equipeSelect = target ? document.querySelector(target) : coordSelect.closest("form")?.querySelector(".js-equipe-select");
 if (!equipeSelect) return;
 preencherEquipes(coordSelect, equipeSelect);
 coordSelect.addEventListener("change", () => preencherEquipes(coordSelect, equipeSelect));
 });

 const formCadastro = document.getElementById("form-cadastro-usuario");
 const gerenciaInput = document.getElementById("cadastro-gerencia");
 const coordCadastro = document.getElementById("cadastro-coord");
 const equipeCadastro = document.getElementById("cadastro-equipe");
 const datalistNomes = document.getElementById("nomes-por-gerencia");
 const nomeInput = document.getElementById("cadastro-nome");
 const emailInput = document.getElementById("cadastro-email");
 const adicionarAtribuidoInput = document.getElementById("adicionar-atribuido-sei");
 const statusExistente = document.getElementById("status-usuario-existente");

 const nomesAtribuidosDaGerencia = () => {
 const ger = gerenciaInput ? (gerenciaInput.value || "") : "";
 return (ger && pessoasPorGerencia[ger]) ? pessoasPorGerencia[ger] : [];
 };

 const popularNomesPorGerencia = () => {
 if (!gerenciaInput || !datalistNomes) return;
 const nomes = nomesAtribuidosDaGerencia();
 datalistNomes.innerHTML = "";
 nomes.forEach((nome) => {
 const opt = document.createElement("option");
 opt.value = nome;
 datalistNomes.appendChild(opt);
 });
 };

 const popularCoordenadoriasPorGerencia = () => {
 if (!gerenciaInput || !coordCadastro) return;
 const ger = gerenciaInput.value || "";
 const coords = (ger && coordenadoriasPorGerencia[ger]) ? coordenadoriasPorGerencia[ger] : [];
 popularOpcoesSelect(coordCadastro, coords, "Selecione (opcional)");
 preencherEquipes(coordCadastro, equipeCadastro);
 };

 const atualizarStatusUsuario = () => {
 if (!nomeInput || !emailInput || !statusExistente) return;
 const nome = normalizar(nomeInput.value);
 const email = normalizar(emailInput.value);
 const iguais = usuariosExistentes.filter((item) => {
 const itemNome = normalizar(item.nome);
 const itemEmail = normalizar(item.email);
 return (nome && itemNome === nome) || (email && itemEmail === email);
 });
 if (!iguais.length) {
 statusExistente.classList.add("d-none");
 statusExistente.textContent = "";
 return;
 }
 const resumo = iguais
 .slice(0, 3)
 .map((item) => `${item.nome || item.username} (${item.email})`)
 .join(" | ");
 statusExistente.classList.remove("d-none");
 statusExistente.textContent = "Ja existe usuario com esse nome ou e-mail. Cadastro sera bloqueado.";
 };

 const atualizarExibicaoPermissaoFinalizar = (selectPerfil) => {
 if (!selectPerfil) return;
 const target = selectPerfil.dataset.target || "";
 if (!target) return;
 const wrapper = document.querySelector(target);
 if (!wrapper) return;
 const ehUsuario = (selectPerfil.value || "").toLowerCase() === "usuario";
 wrapper.classList.toggle("d-none", !ehUsuario);
 const checkbox = wrapper.querySelector('input[name="pode_finalizar_gerencia"]');
 if (checkbox && !ehUsuario) {
 checkbox.checked = true;
 }
 };

 if (formCadastro && gerenciaInput) {
 popularCoordenadoriasPorGerencia();
 gerenciaInput.addEventListener("change", () => {
 datalistNomes.innerHTML = "";
 popularCoordenadoriasPorGerencia();
 atualizarStatusUsuario();
 });
 }

 if (coordCadastro && equipeCadastro) {
 coordCadastro.addEventListener("change", () => preencherEquipes(coordCadastro, equipeCadastro));
 }

 if (nomeInput && emailInput) {
 nomeInput.addEventListener("focus", popularNomesPorGerencia);
 nomeInput.addEventListener("click", popularNomesPorGerencia);
 nomeInput.addEventListener("input", popularNomesPorGerencia);
 nomeInput.addEventListener("input", atualizarStatusUsuario);
 emailInput.addEventListener("input", atualizarStatusUsuario);
 atualizarStatusUsuario();
 }

 document.querySelectorAll(".js-perfil-select").forEach((selectPerfil) => {
 atualizarExibicaoPermissaoFinalizar(selectPerfil);
 selectPerfil.addEventListener("change", () => atualizarExibicaoPermissaoFinalizar(selectPerfil));
 });

 if (formCadastro) {
 formCadastro.addEventListener("submit", (event) => {
 if (!nomeInput || !adicionarAtribuidoInput) return;
 adicionarAtribuidoInput.value = "0";
 const nomeInformado = (nomeInput.value || "").trim();
 if (!nomeInformado) return;
 const nomesLista = nomesAtribuidosDaGerencia();
 const jaExisteNaLista = nomesLista.some((item) => normalizar(item) === normalizar(nomeInformado));
 if (jaExisteNaLista) return;

 const coord = coordCadastro ? (coordCadastro.value || "").trim() : "";
 const equipe = equipeCadastro ? (equipeCadastro.value || "").trim() : "";
 if (!coord || !equipe) {
 const continuar = confirm(
 "Nome novo detectado. Para adicionar na lista de Atribuido SEI, selecione Coordenadoria e Equipe/Setor. Deseja continuar sem adicionar?"
 );
 if (!continuar) {
 event.preventDefault();
 }
 return;
 }

 const incluir = confirm(
 `O nome \"${nomeInformado}\" nao esta na lista de Atribuido SEI da gerencia. Deseja adicionar para ${coord} / ${equipe}?`
 );
 if (incluir) {
 adicionarAtribuidoInput.value = "1";
 }
 });
 }
})();
</script>
</body>
</html>
