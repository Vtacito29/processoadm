<!DOCTYPE html>
<html lang="pt-br">
<head>
 <meta charset="UTF-8">
 <title>Entrar - Controle de Processos</title>
 <meta name="viewport" content="width=device-width, initial-scale=1">
 <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
 <link href="{{ url_for('static', filename='css/global.css') }}" rel="stylesheet">
</head>
<body class="bg-light">
<div class="container py-5">
 {% with mensagens = get_flashed_messages(with_categories=True) %}
 {% if mensagens %}
 <div class="row justify-content-center mb-3">
 <div class="col-12 col-xl-7">
 {% for categoria, mensagem in mensagens %}
 <div class="alert alert-{{ categoria }} alert-dismissible fade show" role="alert">
 {{ mensagem }}
 <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
 </div>
 {% endfor %}
 </div>
 </div>
 {% endif %}
 {% endwith %}

 {% if not current_user.is_authenticated %}
 <div class="row justify-content-center">
 <div class="col-md-6 col-lg-4">
 <div class="card shadow-sm border-0">
 <div class="card-body p-4">
 <h1 class="h4 text-center mb-4">Entrar</h1>
 <form method="post">
 <input type="hidden" name="form_action" value="login">
 <div class="mb-3">
 <label class="form-label" for="username">Usuário ou e-mail</label>
 <input class="form-control" type="text" id="username" name="username" required autofocus>
 </div>
 <div class="mb-3">
 <label class="form-label" for="password">Senha</label>
 <input class="form-control" type="password" id="password" name="password" required>
 </div>
 <div class="form-check mb-3">
 <input class="form-check-input" type="checkbox" id="remember" name="remember">
 <label class="form-check-label" for="remember">Manter-me conectado</label>
 </div>
 <div class="d-grid">
 <button class="btn btn-primary" type="submit">Entrar</button>
 </div>
 </form>
 <div class="text-center mt-3">
 <a href="{{ url_for('index') }}">Voltar ao painel</a>
 </div>
 </div>
 </div>
 </div>
 </div>
 {% endif %}

 {% if current_user.is_authenticated and pode_registrar %}
 <div class="row justify-content-center g-4">
 <div class="col-12 col-xl-7">
 <div class="card shadow-sm border-0">
 <div class="card-body p-4">
 <h2 class="h5 mb-1">Cadastrar novo usuário</h2>
 <p class="text-muted small mb-0">Disponível para assessoria, gerentes e o administrador principal.</p>
 <p class="text-muted small">Informe os dados abaixo e compartilhe a senha temporária gerada automaticamente.</p>
 <form method="post" class="mt-2">
 <input type="hidden" name="form_action" value="register">
 <div class="mb-3">
 <label class="form-label">Nome completo</label>
 <input class="form-control" type="text" name="nome" required>
 </div>
 <div class="mb-3">
 <label class="form-label">E-mail</label>
 <input class="form-control" type="email" name="email" required>
 </div>
 <div class="mb-3">
 <label class="form-label">Gerências</label>
 {% if gerencia_forcada %}
 <input class="form-control" type="text" value="{{ gerencia_padrao_usuario or '' }}" readonly>
 <input type="hidden" name="gerencias" value="{{ gerencia_padrao_usuario or '' }}">
 {% else %}
 <select class="form-select" name="gerencias" multiple required size="6">
 {% for g in gerencias %}
 <option value="{{ g }}">{{ g }}</option>
 {% endfor %}
 </select>
 <div class="form-text">Use Ctrl (ou Command no Mac) para selecionar uma ou mais gerências.</div>
 {% endif %}
 </div>
 <div class="mb-3">
 <label class="form-label">Coordenadoria</label>
 <input class="form-control" type="text" name="coordenadoria">
 </div>
 <div class="mb-3">
 <label class="form-label">Equipe / Setor</label>
 <input class="form-control" type="text" name="equipe_area">
 </div>
 <div class="mb-3">
 <label class="form-label">Perfil de acesso</label>
 <select class="form-select" name="perfil">
 {% for value, label in perfis_disponiveis %}
 <option value="{{ value }}" {% if value == "usuario" %}selected{% endif %}>{{ label }}</option>
 {% endfor %}
 </select>
 </div>
 <div class="mb-3">
 <label class="form-label">O que cada perfil pode fazer</label>
 <div class="small text-muted">
 <p class="mb-1"><strong>Usuário:</strong> visualiza processos de todas as gerências e pode editar/dar segmento apenas nas gerências liberadas.</p>
 <p class="mb-1"><strong>Assessoria:</strong> tudo do Usuário + cadastra processos, exporta relatórios por gerência e cria campos extras nas gerências liberadas.</p>
 <p class="mb-1"><strong>Gerente:</strong> tudo do Usuário + mesmas permissões da Assessoria nas gerências liberadas e pode cadastrar usuários da própria gerência.</p>
 <p class="mb-0"><strong>Acesso total:</strong> perfil especial com acesso geral ao sistema, disponível apenas para o administrador principal.</p>
 </div>
 </div>
 <div class="d-grid">
 <button class="btn btn-outline-primary" type="submit">Gerar acesso</button>
 </div>
 </form>
 {% if criacao_usuario %}
 <div class="alert alert-info mt-3 mb-0">
 <p class="mb-1 fw-semibold">Credenciais temporárias</p>
 <p class="mb-1 small">Usuário: {{ criacao_usuario.username }}</p>
 <p class="mb-0 small">Senha: <code>{{ criacao_usuario.senha }}</code></p>
 </div>
 {% endif %}
 </div>
 </div>

 {% if pode_gerenciar_usuarios %}
 <div class="card shadow-sm border-0 mt-4">
 <div class="card-body p-4">
 <h2 class="h5 mb-1">Gerenciar usuários</h2>
 <p class="text-muted small">Edite dados, gerências e perfil de acesso. Excluir continua disponível nesta seção.</p>
 {% if usuarios_para_gerenciar %}
 <div class="list-group list-group-flush">
 {% for usuario in usuarios_para_gerenciar %}
 <div class="list-group-item px-0">
 <div class="d-flex justify-content-between align-items-start gap-2">
 <div class="small">
 <div class="fw-semibold">{{ usuario.nome or usuario.username }}</div>
 <div class="text-muted">{{ usuario.username }} - {{ usuario.email }}</div>
 <div class="text-muted">Perfil: {{ usuario.perfil }}</div>
 <div class="text-muted">Gerências: {{ usuario.gerencias|join(', ') if usuario.gerencias else '-' }}</div>
 </div>
 <div class="d-flex gap-2">
 <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#editarUsuario{{ usuario.id }}" aria-expanded="false">Editar</button>
 <form method="post" action="{{ url_for('excluir_usuario', usuario_id=usuario.id) }}" onsubmit="return confirm('Excluir este usuário?');">
 <button class="btn btn-sm btn-outline-danger" type="submit">Excluir</button>
 </form>
 </div>
 </div>
 <div class="collapse mt-3" id="editarUsuario{{ usuario.id }}">
 <form method="post" class="row g-2">
 <input type="hidden" name="form_action" value="update_user">
 <input type="hidden" name="usuario_id" value="{{ usuario.id }}">
 <div class="col-md-6">
 <label class="form-label small">Nome</label>
 <input class="form-control form-control-sm" type="text" name="nome" value="{{ usuario.nome }}" required>
 </div>
 <div class="col-md-6">
 <label class="form-label small">E-mail</label>
 <input class="form-control form-control-sm" type="email" name="email" value="{{ usuario.email }}" required>
 </div>
 <div class="col-12">
 <label class="form-label small">Gerências liberadas</label>
 <select class="form-select form-select-sm" name="gerencias" multiple required size="6">
 {% for g in gerencias %}
 <option value="{{ g }}" {% if g in usuario.gerencias %}selected{% endif %}>{{ g }}</option>
 {% endfor %}
 </select>
 </div>
 <div class="col-md-6">
 <label class="form-label small">Coordenadoria</label>
 <input class="form-control form-control-sm" type="text" name="coordenadoria" value="{{ usuario.coordenadoria }}">
 </div>
 <div class="col-md-6">
 <label class="form-label small">Equipe / Setor</label>
 <input class="form-control form-control-sm" type="text" name="equipe_area" value="{{ usuario.equipe_area }}">
 </div>
 <div class="col-md-6">
 <label class="form-label small">Perfil</label>
 <select class="form-select form-select-sm" name="perfil">
 {% for value, label in perfis_disponiveis %}
 <option value="{{ value }}" {% if value == usuario.perfil %}selected{% endif %}>{{ label }}</option>
 {% endfor %}
 </select>
 </div>
 <div class="col-md-6 d-grid align-content-end">
 <button class="btn btn-sm btn-primary mt-4" type="submit">Salvar alterações</button>
 </div>
 </form>
 </div>
 </div>
 {% endfor %}
 </div>
 {% else %}
 <p class="text-muted small mb-0">Nenhum outro usuário cadastrado.</p>
 {% endif %}
 </div>
 </div>
 {% endif %}
 </div>
 </div>
 {% endif %}
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
