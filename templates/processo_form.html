<!-- Arquivo: templates/processo_form.html | Objetivo: formulario de cadastro/edicao/finalizacao de processo -->
<!DOCTYPE html>
<!--
 Template: processo_form.html
 Proposito: Cadastro/edicao de processos em uma gerência.
 Variaveis esperadas:
 - processo: objeto Processo (ou None para novo)
 - modo_edicao: bool para travar campos-chave quando editando
 - current_user, SITE_EM_CONFIGURACAO: controle de exibicao
 Observa&ccedil;&atilde;o: este template usa 'mensagens' se definido pela view; caso contrario,
 considere usar get_flashed_messages() como nos demais templates.
-->
<html lang="pt-br">
<head>
 <meta charset="UTF-8">
 <title>{% if reenviar_devolvido %}Reenviar Processo{% elif modo_edicao %}Editar Processo{% else %}Novo Processo{% endif %}</title>
 <meta name="viewport" content="width=device-width, initial-scale=1">
 <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
 <link href="{{ url_for('static', filename='css/global.css') }}" rel="stylesheet">
 <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
 <link href="{{ url_for('static', filename='css/processo_form.css') }}" rel="stylesheet">
</head>
<body>
<!-- Barra simples com retorno rapido -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
 <div class="container-fluid">
 <a class="navbar-brand" href="{{ url_for('index') }}">Controle de Processos</a>
 <div class="d-flex ms-auto gap-2 align-items-center">
 <a class="btn btn-outline-light btn-sm" href="{% if reenviar_devolvido %}{{ url_for('gerencia', nome_gerencia='GABINETE', aba='devolvidos') }}{% else %}{{ url_for('gerencia', nome_gerencia=processo.gerencia) if processo else url_for('index') }}{% endif %}">
 Voltar
 </a>
 {% if current_user.is_authenticated %}
 <div class="dropdown">
 <button class="btn btn-outline-light btn-sm dropdown-toggle" data-bs-toggle="dropdown">
 Perfil
 </button>
 <div class="dropdown-menu dropdown-menu-end p-0 overflow-hidden">
 <div class="px-3 py-2 small">
 <div class="fw-semibold">{{ current_user.nome or current_user.username }}</div>
 <div class="text-muted">Login: {{ current_user.username }}</div>
 <div class="text-muted">{{ current_user.email or '-' }}</div>
 <div class="text-muted">Gerência: {{ current_user.gerencia_padrao or '-' }}</div>
 <div class="text-muted">
 Perfil:
 {% if current_user.is_admin %}Assessoria{% elif current_user.acesso_total %}Acesso total{% elif current_user.is_gerente %}Gerente{% else %}Usuário{% endif %}
 </div>
 </div>
 <div class="dropdown-divider my-0"></div>
 <a class="dropdown-item small" href="{{ url_for('perfil') }}">Editar perfil</a>
 <a class="dropdown-item small" href="{{ url_for('trocar_senha') }}">Trocar senha</a>
 <a class="dropdown-item text-danger small" href="{{ url_for('logout') }}">Sair</a>
 </div>
 </div>
 {% endif %}
 </div>
 </div>
</nav>

<!-- Formulario principal de cadastro/edicao -->
{% set fd = form_data or {} %}
{% set invalid = campos_invalidos or [] %}
{% set gerencias_sel = selected_gerencias or [] %}
{% set lista_gerencias_cadastro = gerencias_cadastro or GERENCIAS %}
{% set lista_concessionarias = opcoes_concessionarias|default([]) %}
{% set lista_tipos_processo = opcoes_tipo_processo|default([]) %}
{% set lista_interessados = opcoes_interessados|default([]) %}
{% set lista_responsavel_adm = opcoes_responsavel_adm|default([]) %}
{% set lista_status = opcoes_status|default([]) %}
{% set lista_classificacao = opcoes_classificacao|default([]) %}
{% set lista_coordenadorias = opcoes_coordenadorias|default([]) %}
{% set lista_equipes = opcoes_equipes|default([]) %}
{% set mapa_equipes = opcoes_equipes_por_coordenadoria|default({}) %}
{% set lista_responsaveis = opcoes_responsaveis|default([]) %}
{% set mapa_responsaveis = opcoes_responsaveis_por_equipe|default({}) %}
{% set lista_destinos_saida = opcoes_destinos_saida|default([]) %}
{% set somente_visualizacao = somente_visualizacao|default(false) %}
{% set pode_finalizar_gerencia = pode_finalizar_gerencia|default(true) %}
{% set reenviar_devolvido = reenviar_devolvido|default(false) %}

{% if SITE_EM_CONFIGURACAO %}
<div class="card card-form">
 <div class="card-body text-center py-5">
 <h2 class="mb-3">Cadastro indisponvel</h2>
 <p class="text-muted mb-0">Estamos iniciando um novo banco de dados. Assim que as tabelas forem conectadas, o cadastro de processos será reativado.</p>
 </div>
</div>
{% else %}
<div class="card card-form">
 <div class="card-body">
 <h2 class="text-center mb-4">
 {% if reenviar_devolvido %}Reenviar processo devolvido{% elif modo_edicao %}Editar Processo{% else %}Cadastrar Novo Processo{% endif %}
 </h2>
 {% if modo_edicao and somente_visualizacao %}
 <div class="alert alert-info" data-auto-dismiss="1">
 Modo somente visualização. Seu perfil não pode editar ou tramitar processos desta gerência.
 </div>
 {% endif %}
 {% if modo_edicao and not somente_visualizacao and not pode_finalizar_gerencia %}
 <div class="alert alert-info" data-auto-dismiss="1">
 Seu perfil pode visualizar, editar e salvar, mas não pode finalizar processos.
 </div>
 {% endif %}

 <!-- Mensagens de validao do formulrio -->
 {% if mensagens %}
 <div class="mb-3">
 {% for categoria, mensagem in mensagens %}
 <div class="alert alert-{{ categoria }} alert-dismissible fade show" data-auto-dismiss="1">
 {{ mensagem }}
 <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
 </div>
 {% endfor %}
 </div>
 {% endif %}
 

 <form method="post" autocomplete="off" id="processoForm" data-processo-form="1" data-view-only="{{ '1' if somente_visualizacao else '0' }}">
 <input type="hidden" name="redirect_to" id="redirect_to" value="">
 <input type="hidden" name="scroll_y" id="scroll_y" value="{{ scroll_y or '' }}">
 <div class="row g-3">
 <div class="col-md-4">
 <label class="form-label">Data entrada na SUROD</label>
 <input class="form-control {% if 'data_entrada' in invalid %}is-invalid{% endif %}" type="date" name="data_entrada" value="{{ processo.data_entrada|date_input if processo else fd.get('data_entrada','') }}" {% if modo_edicao or reenviar_devolvido %}readonly{% endif %}>
 </div>
 <div class="col-md-4">
 <label class="form-label">Número processo SEI</label>
 {% set numero_sei_exibicao = processo.numero_sei_base if processo else fd.get('sei','') %}
 <input class="form-control {% if 'sei' in invalid %}is-invalid{% endif %}" type="text" id="numero_sei_input" name="sei" value="{{ numero_sei_exibicao }}" {% if modo_edicao or reenviar_devolvido %}readonly{% else %}required{% endif %}>
 {% if not modo_edicao and not reenviar_devolvido %}
 <div id="alertaNumeroSei" class="alert alert-info alert-dismissible small mt-2 d-none" role="alert">
 <span id="alertaNumeroSeiTexto"></span>
 <button type="button" class="btn-close" id="fecharAlertaNumeroSei" aria-label="Fechar"></button>
 </div>
 {% endif %}
 </div>
 <div class="col-md-4">
 <label class="form-label">Prazo - SUROD</label>
 <input class="form-control {% if 'prazo' in invalid %}is-invalid{% endif %}" type="date" name="prazo" value="{{ processo.prazo|date_input if processo else fd.get('prazo','') }}" {% if modo_edicao or reenviar_devolvido %}readonly{% endif %}>
 </div>
 <div class="col-md-6">
 <label class="form-label">Assunto</label>
 <input class="form-control {% if 'assunto' in invalid %}is-invalid{% endif %}" type="text" name="assunto" value="{{ processo.assunto if processo else fd.get('assunto','') }}" {% if not modo_edicao and not reenviar_devolvido %}required{% endif %} {% if modo_edicao or reenviar_devolvido %}readonly{% endif %}>
 </div>
 <div class="col-md-6">
 <label class="form-label">Interessado</label>
 {% set interessado_atual = processo.interessado if processo else fd.get('interessado','') %}
 {% if lista_interessados %}
 {% if modo_edicao or reenviar_devolvido %}
 <input type="hidden" name="interessado" value="{{ interessado_atual }}">
 <input class="form-control" type="text" value="{{ interessado_atual }}" readonly>
 {% else %}
 <div class="select-search">
 <input class="form-control {% if 'interessado' in invalid %}is-invalid{% endif %}" type="text" name="interessado" value="{{ interessado_atual }}" placeholder="Digite para buscar..." {% if not reenviar_devolvido %}required{% endif %} autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" data-options-id="lista_interessados" data-show-on-focus="0" data-require-term="1">
 <div class="select-dropdown" data-options-id="lista_interessados"></div>
 <datalist id="lista_interessados">
 {% if interessado_atual and interessado_atual not in lista_interessados %}
 <option value="{{ interessado_atual }}"></option>
 {% endif %}
 {% for opcao in lista_interessados %}
 <option value="{{ opcao }}"></option>
 {% endfor %}
 </datalist>
 </div>
 {% endif %}
 {% else %}
 <input class="form-control {% if 'interessado' in invalid %}is-invalid{% endif %}" type="text" name="interessado" value="{{ interessado_atual }}" {% if not modo_edicao and not reenviar_devolvido %}required{% endif %} {% if modo_edicao or reenviar_devolvido %}readonly{% endif %}>
 {% endif %}
 </div>
 <div class="col-md-6">
 <label class="form-label">Concessionária (se pertinente)</label>
 {% set concessionaria_atual = processo.concessionaria if processo else fd.get('concessionaria','') %}
 {% if modo_edicao or reenviar_devolvido %}
 <input type="hidden" name="concessionaria" value="{{ concessionaria_atual }}">
 <input class="form-control" type="text" value="{{ concessionaria_atual }}" readonly>
 {% else %}
 <div class="select-search">
 <input class="form-control {% if 'concessionaria' in invalid %}is-invalid{% endif %}" type="text" name="concessionaria" value="{{ concessionaria_atual }}" placeholder="Digite para buscar..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" data-options-id="lista_concessionarias" data-validate-list="1" data-show-on-focus="1" data-show-all-on-focus="1" {% if reenviar_devolvido %}readonly{% endif %}>
 <div class="select-dropdown" data-options-id="lista_concessionarias"></div>
 <datalist id="lista_concessionarias">
 {% for opcao in lista_concessionarias %}
 <option value="{{ opcao }}"></option>
 {% endfor %}
 </datalist>
 </div>
 {% endif %}
 </div>
 <div class="col-md-6" id="campo_gerencia">
 <label class="form-label">Gerências destino</label>
 {% if modo_edicao and not reenviar_devolvido %}
 <select class="form-select" disabled>
 <option selected>{{ processo.gerencia }}</option>
 </select>
 {% else %}
 <div class="gerencia-picker {% if 'gerencias' in invalid %}is-invalid{% endif %}" data-selecionadas="{{ gerencias_sel|join(',') }}" data-invalid="{{ '1' if 'gerencias' in invalid else '' }}">
 <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
 <div>
 <div class="fw-semibold">Selecione as gerências que receberão o processo</div>
 <div class="text-muted small">Todas as selecionadas sero cadastradas ao mesmo tempo.</div>
 </div>
 <span class="badge rounded-pill bg-primary-subtle text-primary border border-primary-subtle">Clique para marcar</span>
 </div>
 <div class="gerencia-picker-grid mt-3">
 {% for g in lista_gerencias_cadastro %}
 <button type="button" class="gerencia-chip" data-value="{{ g }}" aria-pressed="false">
 <span class="chip-order" aria-hidden="true"></span>
 <span class="chip-label">{{ g }}</span>
 </button>
 {% endfor %}
 </div>
 <div class="form-text mt-2 gerencia-picker-hint">
 Clique para selecionar uma ou mais gerências. Repetir o clique remove a seleção. A ordem seguirá a ordem de clique. Cada número SEI receber? o prefixo da gerência correspondente.
 </div>
 <div class="alert alert-warning py-2 px-3 small d-none gerencia-picker-feedback" role="alert" tabindex="-1" data-auto-dismiss="1">
 Escolha pelo menos uma gerência para continuar.
 </div>
 {% if reenviar_devolvido %}
 <div class="alert alert-warning py-2 px-3 small d-none gerencia-picker-status" role="alert"></div>
 <div class="alert alert-info py-2 px-3 small d-none gerencia-picker-confirm" role="alert"></div>
 <input type="hidden" name="confirmar_reenvio" id="confirmar_reenvio" value="0">
 {% endif %}
 <div id="gerenciasHiddenInputs"></div>
 <noscript>
 <select class="form-select mt-2" name="gerencias" multiple required size="6">
  {% for g in lista_gerencias_cadastro %}
 <option value="{{ g }}" {% if g in gerencias_sel %}selected{% endif %}>{{ g }}</option>
 {% endfor %}
 </select>
 <div class="form-text">Segure Ctrl/Command para selecionar mais de uma gerência. A primeira selecionada será a gerência inicial.</div>
 </noscript>
 </div>
 {% endif %}
 </div>
 <div class="col-md-6">
 <label class="form-label">Responsavel Adm</label>
 {% set responsavel_adm_atual = processo.responsavel_adm if processo else (fd.get('responsavel_adm') or current_user.nome or current_user.username) %}
 {% if lista_responsavel_adm %}
 {% if modo_edicao or reenviar_devolvido %}
 <input class="form-control" type="text" name="responsavel_adm" value="{{ responsavel_adm_atual }}" readonly>
 {% else %}
 <div class="select-search">
 <input class="form-control {% if 'responsavel_adm' in invalid %}is-invalid{% endif %}" type="text" name="responsavel_adm" value="{{ responsavel_adm_atual }}" placeholder="Digite para buscar..." {% if not reenviar_devolvido %}required{% endif %} autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" data-options-id="lista_responsavel_adm" data-show-all-on-focus="1" data-default-value="{{ responsavel_adm_atual }}">
 <div class="select-dropdown" data-options-id="lista_responsavel_adm"></div>
 <datalist id="lista_responsavel_adm">
 {% if responsavel_adm_atual and responsavel_adm_atual not in lista_responsavel_adm %}
 <option value="{{ responsavel_adm_atual }}"></option>
 {% endif %}
 {% for opcao in lista_responsavel_adm %}
 <option value="{{ opcao }}"></option>
 {% endfor %}
 </datalist>
 </div>
 {% endif %}
 {% else %}
 <input class="form-control {% if 'responsavel_adm' in invalid %}is-invalid{% endif %}" type="text" name="responsavel_adm" value="{{ responsavel_adm_atual }}" {% if modo_edicao or reenviar_devolvido %}readonly{% endif %}>
 {% endif %}
 </div>
 <div class="col-12">
 <label class="form-label">Observa&ccedil;&atilde;o</label>
 <textarea class="form-control {% if 'observacao' in invalid %}is-invalid{% endif %}" name="observacao" rows="3" {% if modo_edicao or reenviar_devolvido %}readonly{% endif %}>{{ processo.observacao if processo else fd.get('observacao','') }}</textarea>
 </div>
 </div>

{% if modo_edicao %}
 <hr class="my-4">
 {% if processo and processo.gerencia == 'SAIDA' %}
 <div class="card border-0 shadow-sm rounded-4 mb-4" id="ficha-tecnica">
 <div class="card-header bg-white border-0 d-flex align-items-center justify-content-between">
 <div class="fw-semibold">Ficha tcnica</div>
 <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#fichaTecnicaCollapse" aria-expanded="{{ 'true' if mostrar_ficha else 'false' }}" aria-controls="fichaTecnicaCollapse">
 {{ 'Ocultar' if mostrar_ficha else 'Mostrar' }}
 </button>
 </div>
 <div id="fichaTecnicaCollapse" class="collapse{% if mostrar_ficha %} show{% endif %}">
 <div class="card-body">
 {% if ficha_tecnica %}
  <div class="ficha-tecnica-wrapper mb-4">
  {% set classes_gerencia = {
  'GABINETE': 'bg-warning-subtle text-warning border',
  'GEENG': 'bg-info-subtle text-info border',
  'GEPLAN': 'bg-success-subtle text-success border',
  'GEDEX': 'bg-primary-subtle text-primary border',
  'GEFOR': 'bg-danger-subtle text-danger border',
  } %}
  {% set ns_resp_equipe = namespace(keys=[]) %}
  {% for item in demandas_ficha %}
   {% set ger_txt = (item.get('gerencia') or '')|trim|upper %}
   {% set valor_eq = item.get('responsavel_equipe') %}
   {% set valor_txt = (valor_eq if valor_eq is not none else '') ~ '' %}
   {% set valor_txt = valor_txt|trim %}
   {% if ger_txt and valor_txt %}
    {% set chave = ger_txt ~ '|' ~ (valor_txt|upper) %}
    {% if chave not in ns_resp_equipe.keys %}
     {% set _ = ns_resp_equipe.keys.append(chave) %}
    {% endif %}
   {% endif %}
  {% endfor %}
  {% macro classe_por_gerencia(gerencia) -%}
  {%- set texto = (gerencia or '')|replace('->', ',')|replace('|', ',')|replace('-', ',') -%}
  {%- set nome = (texto.split(',')[0] if texto else '')|trim|upper -%}
  {{ classes_gerencia.get(nome, 'bg-light text-dark border') }}
  {%- endmacro %}
  {% macro badges_por_demanda(campo, padrao='-') -%}
  {%- set ns = namespace(keys=[], has=false) -%}
  {%- for item in demandas_ficha -%}
   {%- set valor = item.get(campo) -%}
   {%- set valor_txt = (valor if valor is not none else '') ~ '' -%}
   {%- if valor is none or valor_txt|trim == '' -%}
    {%- set valor_txt = padrao -%}
   {%- endif -%}
   {%- if campo == 'observacoes' -%}
    {%- set valor_txt = valor_txt|replace('\n', ' ') -%}
   {%- endif -%}
   {%- set ger = item.get('gerencia') -%}
   {%- set chave = (ger or '') ~ '|' ~ valor_txt -%}
   {%- if chave not in ns.keys -%}
    {%- set _ = ns.keys.append(chave) -%}
    {%- set ns.has = true -%}
    <span class="badge rounded-pill {{ classe_por_gerencia(ger) }} me-1 mb-1">{{ valor_txt }}</span>
   {%- endif -%}
  {%- endfor -%}
  {%- if not ns.has -%}{{ padrao }}{%- endif -%}
  {%- endmacro %}
  {% macro badges_responsavel_adm(padrao='-') -%}
  {%- set ns = namespace(keys=[], has=false) -%}
  {%- for item in demandas_ficha -%}
   {%- set valor = item.get('responsavel_adm') -%}
   {%- set valor_txt = (valor if valor is not none else '') ~ '' -%}
   {%- if valor is none or valor_txt|trim == '' -%}
    {%- set valor_txt = padrao -%}
   {%- endif -%}
   {%- set ger = item.get('gerencia') -%}
   {%- set chave_nome = valor_txt|trim|upper -%}
   {%- set chave_resp = (ger or '')|trim|upper ~ '|' ~ chave_nome -%}
   {%- if chave_nome and chave_resp in ns_resp_equipe.keys -%}
    {# ignora quando for igual ao responsavel de equipe #}
   {%- else -%}
    {%- set chave = (ger or '') ~ '|' ~ valor_txt -%}
    {%- if chave not in ns.keys -%}
     {%- set _ = ns.keys.append(chave) -%}
     {%- set ns.has = true -%}
     <span class="badge rounded-pill {{ classe_por_gerencia(ger) }} me-1 mb-1">{{ valor_txt }}</span>
    {%- endif -%}
   {%- endif -%}
  {%- endfor -%}
  {%- if not ns.has -%}{{ padrao }}{%- endif -%}
  {%- endmacro %}
  {% macro badges_gerencias() -%}
  {%- set ns = namespace(keys=[], has=false) -%}
  {%- for item in demandas_ficha -%}
   {%- set ger = item.get('gerencia') or '' -%}
   {%- set ger_txt = (ger if ger is not none else '') ~ '' -%}
   {%- set ger_txt = ger_txt|trim -%}
   {%- if ger_txt and ger_txt not in ns.keys -%}
    {%- set _ = ns.keys.append(ger_txt) -%}
    {%- set ns.has = true -%}
    <span class="badge rounded-pill {{ classe_por_gerencia(ger_txt) }} me-1 mb-1">{{ ger_txt }}</span>
   {%- endif -%}
  {%- endfor -%}
  {%- if not ns.has -%}-{% endif -%}
  {%- endmacro %}
  <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
  <div class="ficha-tecnica-title">Ficha t&eacute;cnica</div>
  <div class="d-flex flex-wrap align-items-center gap-2">
  <span class="badge bg-light text-muted border">Processo {{ ficha_tecnica.numero_referencia or '-' }}</span>
  <span class="badge bg-info-subtle text-info border">Demandas {{ ficha_tecnica.total_demandas or 0 }}</span>
  {% if ficha_tecnica.numeros and ficha_tecnica.total_demandas > 1 %}
  <span class="badge bg-light text-muted border">Refs {{ ficha_tecnica.numeros|join(' | ') }}</span>
  {% endif %}
  {% if ficha_tecnica.finalizado_em %}
  <span class="badge bg-success-subtle text-success border">Finalizado {{ ficha_tecnica.finalizado_em|date_br }}</span>
  {% endif %}
  {% if ficha_tecnica.data_entrada %}
  <span class="badge bg-info-subtle text-info border">Entrada {{ ficha_tecnica.data_entrada|date_br }}</span>
  {% endif %}
  </div>
  </div>
  <div class="row g-3">
  <div class="col-md-6 col-lg-4">
  <div class="resumo-box">
  <span class="resumo-label">Assunto</span>
  <span class="resumo-value">{{ ficha_tecnica.assunto or '-' }}</span>
  </div>
  </div>
  <div class="col-md-6 col-lg-4">
  <div class="resumo-box">
  <span class="resumo-label">Interessado</span>
  <span class="resumo-value">{{ ficha_tecnica.interessado or '-' }}</span>
  </div>
  </div>
  <div class="col-md-6 col-lg-4">
  <div class="resumo-box">
  <span class="resumo-label">Concession&aacute;ria</span>
  <span class="resumo-value">{{ ficha_tecnica.concessionaria or '-' }}</span>
  </div>
  </div>
  <div class="col-md-6 col-lg-4">
  <div class="resumo-box">
  <span class="resumo-label">Ger&ecirc;ncias envolvidas</span>
  <span class="resumo-value">{{ badges_gerencias()|safe }}</span>
  </div>
  </div>
  <div class="col-md-6 col-lg-4">
  <div class="resumo-box">
  <span class="resumo-label">Coordenadorias envolvidas</span>
  <span class="resumo-value">{{ badges_por_demanda('coordenadoria')|safe }}</span>
  </div>
  </div>
  <div class="col-md-6 col-lg-4">
  <div class="resumo-box">
  <span class="resumo-label">Equipes / &Aacute;reas envolvidas</span>
  <span class="resumo-value">{{ badges_por_demanda('equipe_area')|safe }}</span>
  </div>
  </div>
  <div class="col-md-6 col-lg-4">
  <div class="resumo-box">
  <span class="resumo-label">Respons&aacute;veis de equipe</span>
  <span class="resumo-value">{{ badges_por_demanda('responsavel_equipe')|safe }}</span>
  </div>
  </div>
  <div class="col-md-6 col-lg-4">
  <div class="resumo-box">
  <span class="resumo-label">Palavras-chave</span>
  <span class="resumo-value">{{ ficha_tecnica.palavras_chave or '-' }}</span>
  </div>
  </div>
  <div class="col-md-6 col-lg-4">
  <div class="resumo-box">
  <span class="resumo-label">Tipo de processo</span>
  <span class="resumo-value">{{ ficha_tecnica.tipo_processo or '-' }}</span>
  </div>
  </div>
  <div class="col-md-6 col-lg-4">
  <div class="resumo-box">
  <span class="resumo-label">Respons&aacute;vel Adm</span>
  <span class="resumo-value">{{ badges_responsavel_adm()|safe }}</span>
  </div>
  </div>
  <div class="col-md-6 col-lg-4">
  <div class="resumo-box">
  <span class="resumo-label">Status</span>
  <span class="resumo-value">{{ badges_por_demanda('status')|safe }}</span>
  </div>
  </div>
  <div class="col-12">
  <div class="resumo-box">
  <span class="resumo-label">Observa&ccedil;&otilde;es</span>
  <span class="resumo-value">{{ (ficha_tecnica.observacoes or 'Nenhuma observacao registrada.')|replace('\n', '<br>')|safe }}</span>
  </div>
  </div>
  {% for campo in ficha_tecnica.campos_extra %}
  {% set extra_valor = (ficha_tecnica.extras_valores or {}).get(campo.slug) %}
  {% if extra_valor %}
  <div class="col-md-6 col-lg-4">
  <div class="resumo-box">
  <span class="resumo-label">{{ campo.label }}</span>
  <span class="resumo-value">{{ extra_valor }}</span>
  </div>
  </div>
  {% endif %}
  {% endfor %}
  </div>
  </div>
 {% else %}
 <div class="row g-3">
 <div class="col-md-4">
 <div class="text-muted small">Número SEI</div>
 <div class="fw-semibold">{{ processo.numero_sei_base or '-' }}</div>
 </div>
 <div class="col-md-4">
 <div class="text-muted small">Gerência</div>
 <div class="fw-semibold">{{ processo.gerencia or '-' }}</div>
 </div>
 <div class="col-md-4">
 <div class="text-muted small">Destino SAÍDA</div>
 <div class="fw-semibold">{{ processo.tramitado_para or '-' }}</div>
 </div>
 <div class="col-md-6">
 <div class="text-muted small">Assunto</div>
 <div class="fw-semibold">{{ processo.assunto or '-' }}</div>
 </div>
 <div class="col-md-6">
 <div class="text-muted small">Interessado</div>
 <div class="fw-semibold">{{ processo.interessado or '-' }}</div>
 </div>
 <div class="col-md-6">
 <div class="text-muted small">Concessionária</div>
 <div class="fw-semibold">{{ processo.concessionaria or '-' }}</div>
 </div>
 <div class="col-md-6">
 <div class="text-muted small">Responsvel ADM</div>
 <div class="fw-semibold">{{ processo.responsavel_adm or '-' }}</div>
 </div>
 <div class="col-md-4">
 <div class="text-muted small">Status</div>
 <div class="fw-semibold">{{ processo.status or 'Em andamento' }}</div>
 </div>
 <div class="col-md-4">
 <div class="text-muted small">Prazo</div>
 <div class="fw-semibold">{{ processo.prazo|date_br if processo.prazo else '-' }}</div>
 </div>
 <div class="col-md-4">
 <div class="text-muted small">Prazo da equipe</div>
 <div class="fw-semibold">{{ processo.prazo_equipe|date_br if processo.prazo_equipe else '-' }}</div>
 </div>
 <div class="col-12">
 <div class="text-muted small">Observaes</div>
 <div class="fw-semibold">{{ (processo.observacoes_complementares or processo.observacao or 'Nenhuma observacao registrada.')|replace('\n', '<br>')|safe }}</div>
 </div>
 </div>
 {% endif %}
 </div>
 </div>
 </div>
 {% endif %}
 {% if processo and processo.gerencia == 'SAIDA' and demandas_relacionadas %}
 <div class="card border-0 shadow-sm rounded-4 mb-4">
 <div class="card-header bg-white border-0">
 <div class="fw-semibold">Demandas deste processo</div>
 <div class="text-muted small">Todas as gerências envolvidas precisam estar na SAÍDA para finalizar.</div>
 </div>
 <div class="card-body">
 <div class="table-responsive">
 <table class="table table-sm align-middle">
 <thead class="table-light">
 <tr>
 <th>Gerência</th>
 <th>Número SEI</th>
 <th>Status</th>
 <th>Coordenadoria</th>
 <th>Equipe / rea</th>
 <th>Responsvel equipe</th>
 <th>Responsvel Adm</th>
 </tr>
 </thead>
 <tbody>
 {% for item in demandas_relacionadas %}
 <tr>
 <td class="fw-semibold">{{ item.gerencia or "-" }}</td>
 <td>{{ item.numero_sei_base or item.numero_sei or "-" }}</td>
 <td>{{ item.status or "-" }}</td>
 <td>{{ item.coordenadoria or "-" }}</td>
 <td>{{ item.equipe_area or "-" }}</td>
 <td>{{ item.responsavel_equipe or "-" }}</td>
 <td>{{ item.responsavel_adm or "-" }}</td>
 </tr>
 {% endfor %}
 </tbody>
 </table>
 </div>
 </div>
 </div>
 {% endif %}
 <h3 class="section-title">Informa&ccedil;&otilde;es complementares</h3>
 {% if not (processo and processo.gerencia == 'SAIDA') %}
 <div class="row g-3">
 <div class="col-md-6">
 <label class="form-label">Classificacao institucional</label>
 {% set classificacao_atual = processo.classificacao_institucional or '' %}
 {% if lista_classificacao %}
 <div class="select-search">
 <input class="form-control" type="text" name="classificacao_institucional" value="{{ classificacao_atual }}" placeholder="Digite para buscar..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" data-options-id="lista_classificacao" data-validate-list="1">
 <div class="select-dropdown" data-options-id="lista_classificacao"></div>
 <datalist id="lista_classificacao">
 {% if classificacao_atual and classificacao_atual not in lista_classificacao %}
 <option value="{{ classificacao_atual }}"></option>
 {% endif %}
 {% for opcao in lista_classificacao %}
 <option value="{{ opcao }}"></option>
 {% endfor %}
 </datalist>
 </div>
 {% else %}
 <input class="form-control" type="text" name="classificacao_institucional" value="{{ classificacao_atual }}">
 {% endif %}
 </div>
 </div>
 <div class="row g-3">
 <div class="col-md-4">
 <label class="form-label">Data de entrada na {{ processo.gerencia }}</label>
 <input class="form-control" type="date" value="{{ data_entrada_gerencia_atual|date_input }}" readonly>
 </div>
 <div class="col-12">
 <label class="form-label">Descri&ccedil;&atilde;o melhorada</label>
 <textarea class="form-control" name="descricao_melhorada" rows="3">{{ processo.descricao_melhorada or '' }}</textarea>
 </div>
 <div class="col-12">
 <small class="text-muted">Campos marcados com * s&atilde;o obrigat&oacute;rios para finalizar.</small>
 </div>
 <div class="col-md-4">
  <label class="form-label">Coordenadoria <span class="text-danger">*</span></label>
 {% set coordenadoria_atual = processo.coordenadoria or '' %}
 {% if lista_coordenadorias %}
 <div class="select-search">
 <input class="form-control" type="text" id="coordenadoria" name="coordenadoria" value="{{ coordenadoria_atual }}" placeholder="Digite para buscar..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" data-required-finalize="1" data-options-id="lista_coordenadorias" data-validate-list="1">
 <div class="select-dropdown" data-options-id="lista_coordenadorias"></div>
 <datalist id="lista_coordenadorias">
 {% if coordenadoria_atual and coordenadoria_atual not in lista_coordenadorias %}
 <option value="{{ coordenadoria_atual }}"></option>
 {% endif %}
 {% for opcao in lista_coordenadorias %}
 <option value="{{ opcao }}"></option>
 {% endfor %}
 </datalist>
 </div>
 {% else %}
 <input class="form-control" type="text" id="coordenadoria" data-required-finalize="1" name="coordenadoria" value="{{ coordenadoria_atual }}">
 {% endif %}
 </div>
 <div class="col-md-4">
  <label class="form-label">Equipe / &Aacute;rea <span class="text-danger">*</span></label>
 {% set equipe_atual = processo.equipe_area or '' %}
 {% if mapa_equipes or lista_equipes %}
 <div class="select-search">
 <input class="form-control" type="text" id="equipe_area" name="equipe_area" value="{{ equipe_atual }}" placeholder="Digite para buscar..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" data-required-finalize="1" data-options-id="lista_equipe_area" data-validate-list="1">
 <div class="select-dropdown" data-options-id="lista_equipe_area"></div>
 <datalist id="lista_equipe_area">
 {% if equipe_atual and equipe_atual not in lista_equipes %}
 <option value="{{ equipe_atual }}"></option>
 {% endif %}
 {% for opcao in lista_equipes %}
 <option value="{{ opcao }}"></option>
 {% endfor %}
 </datalist>
 </div>
 {% else %}
 <input class="form-control" type="text" id="equipe_area" data-required-finalize="1" name="equipe_area" value="{{ equipe_atual }}">
 {% endif %}
 </div>
 <div class="col-md-4">
  <label class="form-label">Atribu&iacute;do SEI <span class="text-danger">*</span></label>
 {% set responsavel_atual = processo.responsavel_equipe or '' %}
{% if mapa_responsaveis or lista_responsaveis %}
 <div class="select-search">
 <input class="form-control" type="text" id="responsavel_equipe" name="responsavel_equipe" value="{{ responsavel_atual }}" placeholder="Digite para buscar..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" data-required-finalize="1" data-options-id="lista_responsaveis" data-validate-list="1">
 <div class="select-dropdown" data-options-id="lista_responsaveis"></div>
 <datalist id="lista_responsaveis">
 {% if responsavel_atual and responsavel_atual not in lista_responsaveis %}
 <option value="{{ responsavel_atual }}"></option>
 {% endif %}
 {% for opcao in lista_responsaveis %}
 <option value="{{ opcao }}"></option>
 {% endfor %}
 </datalist>
 </div>
 {% else %}
 <input class="form-control" type="text" id="responsavel_equipe" data-required-finalize="1" name="responsavel_equipe" value="{{ responsavel_atual }}">
 {% endif %}
 </div>
 <div class="col-md-4">
 <label class="form-label">Tipo de processo</label>
 {% set tipo_atual = processo.tipo_processo or '' %}
 {% if lista_tipos_processo %}
 <div class="select-search">
 <input class="form-control" type="text" name="tipo_processo" value="{{ tipo_atual }}" placeholder="Digite para buscar..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" data-options-id="lista_tipos_processo">
 <div class="select-dropdown" data-options-id="lista_tipos_processo"></div>
 <datalist id="lista_tipos_processo">
 {% if tipo_atual and tipo_atual not in lista_tipos_processo %}
 <option value="{{ tipo_atual }}"></option>
 {% endif %}
 {% for opcao in lista_tipos_processo %}
 <option value="{{ opcao }}"></option>
 {% endfor %}
 </datalist>
 </div>
 {% else %}
 <input class="form-control" type="text" name="tipo_processo" value="{{ tipo_atual }}">
 {% endif %}
 </div>
 <div class="col-md-4">
 <label class="form-label">Palavras-chave</label>
 <input class="form-control" type="text" name="palavras_chave" value="{{ processo.palavras_chave or '' }}">
 </div>
 <div class="col-md-4">
  <label class="form-label">Status <span class="text-danger">*</span></label>
 {% set status_atual = processo.status or '' %}
 {% if lista_status %}
 <div class="select-search">
 <input class="form-control" type="text" name="status" id="status" value="{{ status_atual }}" placeholder="Digite para buscar..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" data-required-finalize="1" data-options-id="lista_status" data-validate-list="1">
 <div class="select-dropdown" data-options-id="lista_status"></div>
 <datalist id="lista_status">
 {% if status_atual and status_atual not in lista_status %}
 <option value="{{ status_atual }}"></option>
 {% endif %}
 {% for opcao in lista_status %}
 <option value="{{ opcao }}"></option>
 {% endfor %}
 </datalist>
 </div>
 {% else %}
 <input class="form-control" type="text" name="status" id="status" data-required-finalize="1" value="{{ status_atual }}">
 {% endif %}
 </div>
 <!-- Data status e atualizada automaticamente ao mudar o status -->
 <div class="col-md-4">
 <label class="form-label">Prazo da equipe</label>
 <input class="form-control" type="date" name="prazo_equipe" value="{{ processo.prazo_equipe|date_input }}">
 </div>
 {% if campos_extra %}
 <hr class="my-2">
 <div class="col-12">
 <h3 class="section-title mb-3">Campos extras desta gerência</h3>
 </div>
 {% for campo in campos_extra %}
 <div class="col-md-4">
 <label class="form-label">{{ campo.label }}</label>
 {% if campo.tipo == 'data' %}
 <input class="form-control" type="date" name="extra_{{ campo.slug }}" value="{{ valores_extra.get(campo.slug, '') }}">
 {% elif campo.tipo == 'numero' %}
 <input class="form-control" type="number" step="any" name="extra_{{ campo.slug }}" value="{{ valores_extra.get(campo.slug, '') }}">
 {% else %}
 <input class="form-control" type="text" name="extra_{{ campo.slug }}" value="{{ valores_extra.get(campo.slug, '') }}">
 {% endif %}
 <div class="form-text">Slug: <code>{{ campo.slug }}</code></div>
 </div>
 {% endfor %}
 {% if pode_configurar_campos %}
 <div class="col-12 d-flex flex-wrap gap-2 mt-2">
 <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('gerencia_campos', nome_gerencia=processo.gerencia) }}">Configurar campos desta gerência</a>
 </div>
 {% endif %}
 {% endif %}
 <!-- Data de saida e registrada automaticamente ao finalizar o processo -->
 <div class="col-12">
 <label class="form-label">Observa&ccedil;&otilde;es complementares</label>
 <textarea class="form-control" name="obs" rows="3">{{ processo.observacoes_complementares or '' }}</textarea>
 </div>
 <!-- Grupo de acoes abaixo de Observa&ccedil;&otilde;es complementares (apenas Salvar/Cancelar) -->
 {% if modo_edicao and processo and processo.gerencia != 'SAIDA' and not somente_visualizacao %}
 <div class="col-12">
 <div class="d-flex flex-wrap gap-2 justify-content-start mt-3">
 <button class="btn btn-primary btn-lg" type="button" id="btnSalvarEdicao">Salvar</button>
 <a class="btn btn-outline-secondary btn-lg d-none" href="{{ url_for('gerencia', nome_gerencia=processo.gerencia) }}" id="btnVoltarGerencia">Voltar</a>
 <div class="text-success small d-none align-self-center" id="msgSalvo">Salvo</div>
 </div>
 </div>
 {% endif %}
 <div class="col-md-6">
 <label class="form-label">Tramitar para <span class="text-danger">*</span></label>
 <div class="select-search">
 {% set tramitado_atual = processo.tramitado_para or '' %}
 {% if tramitado_atual == 'GABINETE' %}
 {% set tramitado_atual = GERENCIA_ALIAS_GABINETE %}
 {% endif %}
 <input class="form-control" type="text" name="tramitado_para" id="tramitado_para" value="{{ tramitado_atual }}" placeholder="Digite para buscar..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" data-required-finalize="1" data-options-id="lista_tramite" data-validate-list="1">
 <div class="select-dropdown" data-options-id="lista_tramite"></div>
 <datalist id="lista_tramite">
 {% set gerencia_atual = processo.gerencia %}
 {% set deve_incluir_atual = tramitado_atual
 and (
 tramitado_atual not in GERENCIAS_TRAMITE_EXIBICAO
 or tramitado_atual == gerencia_atual
 or (gerencia_atual == 'GABINETE' and tramitado_atual == GERENCIA_ALIAS_GABINETE)
 ) %}
 {% if deve_incluir_atual %}
 <option value="{{ tramitado_atual }}"></option>
 {% endif %}
 {% for g in GERENCIAS_TRAMITE_EXIBICAO %}
 {% if not (g == gerencia_atual or (g == GERENCIA_ALIAS_GABINETE and gerencia_atual == 'GABINETE')) %}
 <option value="{{ g }}"></option>
 {% endif %}
 {% endfor %}
 </datalist>
 </div>
 </div>
 </div>
 {% else %}
 <div class="row g-3">
 <div class="col-md-6{% if mostrar_devolver %} d-none{% endif %}">
 <label class="form-label">Destino SAÍDA</label>
 <div class="select-search">
 <input class="form-control" type="text" name="destino_saida" id="destino_saida" value="{{ processo.tramitado_para or '' }}" placeholder="Digite para buscar..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" data-options-id="lista_tramite_saida" data-validate-list="1" {% if not mostrar_devolver %}required{% endif %}>
 <div class="select-dropdown" data-options-id="lista_tramite_saida"></div>
 <datalist id="lista_tramite_saida">
 {% if processo.tramitado_para and processo.tramitado_para not in lista_destinos_saida %}
 <option value="{{ processo.tramitado_para }}"></option>
 {% endif %}
 {% for destino in lista_destinos_saida %}
 <option value="{{ destino }}"></option>
 {% endfor %}
 </datalist>
 </div>
 <div class="form-text">Selecione o destino para registro na SAÍDA.</div>
 </div>
 <div class="col-md-6 {% if not mostrar_devolver %}d-none{% endif %}" id="devolver_wrapper">
 <label class="form-label">Devolver para</label>
 <div class="select-search">
 <input class="form-control" type="text" name="devolver_para" id="devolver_para" value="{{ valor_devolver or '' }}" placeholder="Digite para buscar..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" data-options-id="lista_devolver_para" data-validate-list="1">
 <div class="select-dropdown" data-options-id="lista_devolver_para"></div>
 <datalist id="lista_devolver_para">
 {% for g in GERENCIAS %}
 {% if g != 'SAIDA' %}<option value="{{ g }}"></option>{% endif %}
 {% endfor %}
 </datalist>
 </div>
 <div class="form-text">Selecione a gerência para devolver o processo.</div>
 </div>
 </div>
 {% endif %}
 {% endif %}

{% if alerta_tramite %}
<div class="alert alert-warning py-2 px-3 small mb-2 alert-dismissible fade show">
 A gerência {{ alerta_tramite }} já possui uma demanda deste processo. Envio bloqueado.
 <div class="d-flex flex-wrap gap-2 mt-2">
 <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="alert">OK</button>
 </div>
</div>
{% endif %}

 {% if pode_finalizar_gerencia %}
 <div id="alertaObrigatoriosFinalizar" class="alert alert-warning py-2 px-3 small mb-2 d-none" role="alert">
  Preencha os campos obrigat&oacute;rios para finalizar: <span id="listaObrigatoriosFinalizar"></span>.
  <button type="button" class="btn-close" aria-label="Fechar" data-close-alert="obrigatorios"></button>
 </div>
 {% endif %}

 <div class="d-flex flex-wrap gap-2 justify-content-start mt-4">
 {% if modo_edicao and not somente_visualizacao %}
 {% if processo %}
 {% if processo.gerencia == 'SAIDA' and pode_finalizar_gerencia %}
 {% if mostrar_devolver %}
 <input type="hidden" name="comentario" value="Devolucao pela SAÍDA">
 <input type="hidden" name="nova_gerencia" id="nova_gerencia_hidden">
 <input type="hidden" name="confirmar_devolver" id="confirmar_devolver_hidden" value="0">
 <button class="btn btn-outline-primary btn-lg" type="submit" id="btnDevolver" name="acao" value="devolver" disabled>Devolver</button>
 {% endif %}
 {% if bloquear_finalizacao_saida and gerencias_relacionadas %}
 <div class="alert alert-warning py-2 px-3 small mb-2 alert-dismissible fade show">
 Existem demandas ativas deste processo em: {{ gerencias_relacionadas | join(", ") }}.
 Finalize apenas quando todas as demandas estiverem finalizadas.
 <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fechar"></button>
 </div>
 {% endif %}
 {% if not mostrar_devolver %}
 <button class="btn btn-success btn-lg" type="submit" id="acao-finalizar" data-finalize="1" formaction="{{ url_for('finalizar_processo', processo_id=processo.id) }}">Finalizar na SAÍDA</button>
 {% endif %}
 {% elif pode_finalizar_gerencia %}
 <button class="btn btn-success btn-lg" type="submit" id="botaoFinalizar" data-finalize="1" formaction="{{ url_for('finalizar_processo', processo_id=processo.id) }}">Finalizar</button>
 {% endif %}
 {% endif %}
 {% elif modo_edicao and somente_visualizacao %}
 <a class="btn btn-outline-secondary btn-lg" href="{{ url_for('gerencia', nome_gerencia=processo.gerencia) if processo else url_for('index') }}" data-exit-link="1">Voltar</a>
 {% else %}
 {% if reenviar_devolvido %}
 <button class="btn btn-primary btn-lg" type="submit">Reenviar</button>
 <a class="btn btn-outline-secondary btn-lg" href="{{ url_for('gerencia', nome_gerencia='GABINETE', aba='devolvidos') }}" data-exit-link="1">Cancelar</a>
 {% else %}
 <button class="btn btn-primary btn-lg" type="submit">Cadastrar</button>
 <a class="btn btn-outline-secondary btn-lg" href="{{ url_for('index') }}" data-exit-link="1">Cancelar</a>
 {% endif %}
 {% endif %}
 </div>
 </form>

 <div class="modal fade" id="modalSaidaSemSalvar" tabindex="-1" aria-hidden="true">
 <div class="modal-dialog modal-dialog-centered">
 <div class="modal-content">
 <div class="modal-header">
 <h5 class="modal-title">Alteraes no salvas</h5>
 <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
 </div>
 <div class="modal-body">
 Você possui alteraçóes não salvas. Deseja salvar antes de sair?
 </div>
 <div class="modal-footer">
 <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
 <button type="button" class="btn btn-outline-danger" id="btnSairSemSalvar">Sair sem salvar</button>
 <button type="button" class="btn btn-primary" id="btnSalvarESair">Salvar e sair</button>
 </div>
 </div>
 </div>
 </div>

 </div>
</div>
{% endif %}
{% if not modo_edicao %}
<script>
 document.addEventListener("DOMContentLoaded", function () {
 const picker = document.querySelector(".gerencia-picker");
 if (!picker) return;

 const chips = Array.from(picker.querySelectorAll(".gerencia-chip"));
 const hiddenContainer = picker.querySelector("#gerenciasHiddenInputs");
 const feedback = picker.querySelector(".gerencia-picker-feedback");
 const avisoStatus = picker.querySelector(".gerencia-picker-status");
 const avisoConfirm = picker.querySelector(".gerencia-picker-confirm");
 const form = picker.closest("form");
 const confirmHidden = document.getElementById("confirmar_reenvio");
 const statusGerencias = {{ status_gerencias|default({})|tojson }};
 const gerenciasAtivas = new Set((statusGerencias.ativas || []));
 const gerenciasFinalizadas = new Set((statusGerencias.finalizadas || []));
 const gerenciasDevolvidas = new Set((statusGerencias.devolvidas || []));
 const gerenciasBloqueadas = new Set([
 ...Array.from(gerenciasAtivas),
 ...Array.from(gerenciasFinalizadas),
 ]);
 const initial = (picker.dataset.selecionadas || "")
 .split(",")
 .map((v) => v.trim())
 .filter(Boolean);
 const selections = [...initial];

 const definirAviso = (el, mensagem) => {
 if (!el) return;
 el.textContent = mensagem;
 el.classList.remove("d-none");
 };
 const limparAviso = (el) => {
 if (!el) return;
 el.textContent = "";
 el.classList.add("d-none");
 };
 const motivoBloqueio = (ger) => {
 if (gerenciasAtivas.has(ger)) {
 return `A ger\u00eancia ${ger} j\u00e1 possui demanda ativa deste processo. Envio bloqueado para a mesma ger\u00eancia. Voc\u00ea pode cadastrar nova demanda para outra ger\u00eancia liberada.`;
 }
 if (gerenciasFinalizadas.has(ger)) {
 return `A ger\u00eancia ${ger} j\u00e1 possui demanda finalizada deste processo. Envio bloqueado para a mesma ger\u00eancia.`;
 }
 return "Envio bloqueado para esta ger\u00eancia.";
 };
 const atualizarAvisosSelecao = () => {
 const devolvidasSel = selections.filter((ger) => gerenciasDevolvidas.has(ger));
 if (devolvidasSel.length) {
 definirAviso(
 avisoConfirm,
 `A(s) gerência(s) ${devolvidasSel.join(", ")} já devolveram este processo. Ser? solicitada confirmao no envio.`
 );
 } else {
 limparAviso(avisoConfirm);
 }
 };
 const removerBloqueadas = () => {
 for (let i = selections.length - 1; i >= 0; i -= 1) {
 if (gerenciasBloqueadas.has(selections[i])) {
 selections.splice(i, 1);
 }
 }
 };
 const syncUI = () => {
 removerBloqueadas();
 if (hiddenContainer) {
 hiddenContainer.innerHTML = "";
 selections.forEach((value) => {
 const input = document.createElement("input");
 input.type = "hidden";
 input.name = "gerencias";
 input.value = value;
 hiddenContainer.appendChild(input);
 });
 }

 chips.forEach((chip) => {
 const value = chip.dataset.value;
 const index = selections.indexOf(value);
 const active = index !== -1;
 chip.classList.toggle("active", active);
 chip.setAttribute("aria-pressed", active);
 const badge = chip.querySelector(".chip-order");
 if (badge) {
 badge.textContent = active ? String(index + 1) : "";
 }
 });

 if (feedback && selections.length) {
 feedback.classList.add("d-none");
 }
 if (confirmHidden) {
 confirmHidden.value = "0";
 }
 atualizarAvisosSelecao();
 };

 chips.forEach((chip) => {
 const value = chip.dataset.value;
 if (gerenciasBloqueadas.has(value)) {
 chip.classList.add("disabled");
 chip.setAttribute("aria-disabled", "true");
 chip.setAttribute("title", motivoBloqueio(value));
 }
 });

 chips.forEach((chip) => {
 chip.addEventListener("click", () => {
 const value = chip.dataset.value;
 if (gerenciasBloqueadas.has(value)) {
 definirAviso(avisoStatus, motivoBloqueio(value));
 return;
 }
 limparAviso(avisoStatus);
 const index = selections.indexOf(value);
 if (index === -1) {
 selections.push(value);
 } else {
 selections.splice(index, 1);
 }
 syncUI();
 });
 });

 if (form) {
 form.addEventListener("submit", (event) => {
 if (!selections.length) {
 event.preventDefault();
 if (feedback) {
 feedback.classList.remove("d-none");
 if (typeof feedback.scrollIntoView === "function") {
 feedback.scrollIntoView({ behavior: "smooth", block: "center" });
 }
 if (typeof feedback.focus === "function") {
 feedback.focus();
 }
 }
 return;
 }
 const devolvidasSel = selections.filter((ger) => gerenciasDevolvidas.has(ger));
 if (devolvidasSel.length && confirmHidden && confirmHidden.value !== "1") {
 event.preventDefault();
 const mensagem = `A(s) gerência(s) ${devolvidasSel.join(", ")} já devolveram este processo. Deseja reenviar novamente?`;
 if (window.confirm(mensagem)) {
 confirmHidden.value = "1";
 form.submit();
 }
 return;
 }
 if (feedback) {
 feedback.classList.add("d-none");
 }
 });
 }

 if (!selections.length && picker.dataset.invalid === "1" && feedback) {
 feedback.classList.remove("d-none");
 }
 syncUI();
 });
</script>
{% if not reenviar_devolvido %}
<script>
 document.addEventListener("DOMContentLoaded", function () {
 const inputSei = document.getElementById("numero_sei_input");
 const form = document.getElementById("processoForm");
 const inputAssunto = form ? form.querySelector('input[name="assunto"]') : null;
 const inputInteressado = form ? form.querySelector('input[name="interessado"]') : null;
 const inputConcessionaria = form ? form.querySelector('input[name="concessionaria"]') : null;
 const alertaNumero = document.getElementById("alertaNumeroSei");
 const alertaNumeroTexto = document.getElementById("alertaNumeroSeiTexto");
 const fecharAlertaNumeroSei = document.getElementById("fecharAlertaNumeroSei");
 const endpoint = "{{ url_for('inspecionar_numero_processo') }}";
 let timer = null;
 let token = 0;
 let prefillReferencia = null;

 const limparAlerta = () => {
 if (!alertaNumero) return;
 alertaNumero.classList.add("d-none");
 if (alertaNumeroTexto) {
 alertaNumeroTexto.textContent = "";
 }
 alertaNumero.classList.remove("alert-warning", "alert-info", "alert-success", "alert-danger");
 };

 const mostrarAlerta = (tipo, mensagem) => {
 if (!alertaNumero) return;
 if (alertaNumeroTexto) {
 alertaNumeroTexto.textContent = mensagem;
 }
 alertaNumero.classList.remove("d-none");
 alertaNumero.classList.remove("alert-warning", "alert-info", "alert-success", "alert-danger");
 alertaNumero.classList.add(tipo);
 };

 if (fecharAlertaNumeroSei) {
 fecharAlertaNumeroSei.addEventListener("click", () => {
 alertaNumero?.classList.add("d-none");
 });
 }

 const renderizarInspecao = (dados) => {
 const numeroBase = (dados && dados.numero_base) ? String(dados.numero_base).trim() : "";
 const ativos = Number(dados && dados.ativos_count ? dados.ativos_count : 0);
 const gerencias = Array.isArray(dados && dados.ativos_gerencias) ? dados.ativos_gerencias.filter(Boolean) : [];
 const prefill = dados && dados.prefill ? dados.prefill : null;

 if (!numeroBase) {
 prefillReferencia = null;
 limparAlerta();
 return;
 }

 if (prefill && (inputAssunto || inputInteressado || inputConcessionaria)) {
 const assunto = (prefill.assunto || "").toString();
 const interessado = (prefill.interessado || "").toString();
 const concessionaria = (prefill.concessionaria || "").toString();
 if (inputAssunto) inputAssunto.value = assunto;
 if (inputInteressado) inputInteressado.value = interessado;
 if (inputConcessionaria) inputConcessionaria.value = concessionaria;
 prefillReferencia = {
 assunto,
 interessado,
 concessionaria,
 totalRelacionados: Number(prefill.total_relacionados || 0),
 origem: (prefill.origem || "").toString(),
 };
 }

 if (ativos > 0) {
 let mensagem = `J\u00e1 existe(m) ${ativos} demanda(s) ativa(s) para este n\u00famero`;
 if (gerencias.length) {
 mensagem += ` em: ${gerencias.join(", ")}.`;
 } else {
 mensagem += ".";
 }
 mensagem += " N\u00e3o \u00e9 permitido abrir nova demanda na mesma ger\u00eancia enquanto houver demanda ativa.";
 mensagem += " Se precisar tratar um novo assunto agora, cadastre a demanda em outra ger\u00eancia liberada.";
 mensagem += " Para cadastrar novamente na mesma ger\u00eancia, finalize primeiro a demanda ativa.";
 if (prefillReferencia) {
 mensagem += " Os campos Assunto, Interessado e Concession\u00e1ria foram preenchidos automaticamente com base na demanda ativa.";
 }
 mostrarAlerta("alert-warning", mensagem);
 return;
 }

 if (prefillReferencia) {
 const origemTxt = prefillReferencia.origem === "ativa" ? "demanda ativa" : "demanda finalizada";
 mostrarAlerta(
 "alert-info",
 `Dados preenchidos automaticamente com base na ${origemTxt} deste processo. Se voc\u00ea alterar Assunto, Interessado ou Concession\u00e1ria ao cadastrar, essa altera\u00e7\u00e3o ser\u00e1 aplicada em todas as demandas deste processo.`
 );
 return;
 }

 limparAlerta();
};

 const consultarNumero = (numero) => {
 const valor = (numero || "").trim();
 if (!valor) {
 renderizarInspecao({ numero_base: "" });
 return;
 }
 const tokenAtual = ++token;
 fetch(`${endpoint}?numero=${encodeURIComponent(valor)}`, { credentials: "same-origin" })
 .then((resp) => (resp.ok ? resp.json() : Promise.reject()))
 .then((dados) => {
 if (tokenAtual !== token) return;
 renderizarInspecao(dados || {});
 })
 .catch(() => {
 if (tokenAtual !== token) return;
 mostrarAlerta("alert-danger", "Não foi poss?vel validar o número no momento.");
 });
 };

 if (inputSei) {
 inputSei.addEventListener("input", () => {
 if (timer) {
 clearTimeout(timer);
 }
 timer = setTimeout(() => {
 consultarNumero(inputSei.value);
 }, 400);
 });
 inputSei.addEventListener("blur", () => {
 if (timer) {
 clearTimeout(timer);
 }
 consultarNumero(inputSei.value);
 });
 if (inputSei.value && inputSei.value.trim()) {
 consultarNumero(inputSei.value);
 }
 }

 if (form) {
 form.addEventListener("submit", (event) => {
 if (!prefillReferencia) return;
 const assuntoAtual = (inputAssunto?.value || "").trim();
 const interessadoAtual = (inputInteressado?.value || "").trim();
 const concessionariaAtual = (inputConcessionaria?.value || "").trim();
 const mudou =
 assuntoAtual !== (prefillReferencia.assunto || "").trim()
 || interessadoAtual !== (prefillReferencia.interessado || "").trim()
 || concessionariaAtual !== (prefillReferencia.concessionaria || "").trim();
 if (!mudou) return;
 const total = prefillReferencia.totalRelacionados || 0;
 const msg = `Você alterou dados-base do processo. Essa alteração será aplicada em todas as demandas relacionadas (${total}). Deseja continuar?`;
 if (!window.confirm(msg)) {
 event.preventDefault();
 }
 });
 }
 });
</script>
{% endif %}
{% endif %}
<script>
 document.addEventListener("DOMContentLoaded", function () {
 const normalizarTexto = (valor) => {
 return (valor || "")
 .toString()
 .trim()
 .toLowerCase()
 .normalize("NFD")
 .replace(/[\u0300-\u036f]/g, "");
 };

 const obterOpcoes = (listId) => {
 const datalist = listId ? document.getElementById(listId) : null;
 if (!datalist) return [];
 return Array.from(datalist.querySelectorAll("option"))
 .map((opt) => opt.value)
 .filter(Boolean);
 };

 const deduplicar = (opcoes) => Array.from(new Set(opcoes));

 const renderizarOpcoes = (dropdown, opcoes) => {
 dropdown.innerHTML = "";
 opcoes.forEach((opcao) => {
 const botao = document.createElement("button");
 botao.type = "button";
 botao.className = "select-option";
 botao.textContent = opcao;
 botao.dataset.value = opcao;
 dropdown.appendChild(botao);
 });
 };

 const configurarSelectSearch = (wrapper) => {
 const input = wrapper.querySelector("input[data-options-id]");
 const dropdown = wrapper.querySelector(".select-dropdown");
 if (!input || !dropdown) return;

 const listId = input.dataset.optionsId || dropdown.dataset.optionsId;
 if (!listId) return;
 const showOnFocus = input.dataset.showOnFocus !== "0";
 const requireTerm = input.dataset.requireTerm === "1";
 const showAllOnFocus = input.dataset.showAllOnFocus === "1";

 input.setAttribute("role", "combobox");
 input.setAttribute("aria-autocomplete", "list");
 input.setAttribute("aria-expanded", "false");
 dropdown.setAttribute("role", "listbox");

 const abrirDropdown = () => {
 const opcoes = deduplicar(obterOpcoes(listId));
 if (!opcoes.length) return;
 dropdown.classList.add("show");
 input.setAttribute("aria-expanded", "true");
 };

 const fecharDropdown = () => {
 dropdown.classList.remove("show");
 input.setAttribute("aria-expanded", "false");
 };

 const filtrarOpcoes = () => {
 const termo = normalizarTexto(input.value);
 if (requireTerm && !termo) {
 renderizarOpcoes(dropdown, []);
 fecharDropdown();
 return;
 }
 const opcoes = deduplicar(obterOpcoes(listId));
 const opcoesNormalizadas = opcoes.map((opcao) => normalizarTexto(opcao));
 const filtradas = opcoes.filter((opcao, indice) => {
 if (!termo) return true;
 return opcoesNormalizadas[indice].includes(termo);
 });
 renderizarOpcoes(dropdown, filtradas);
 if (document.activeElement !== input) {
 fecharDropdown();
 return;
 }
 if (filtradas.length) {
 abrirDropdown();
 } else {
 fecharDropdown();
 }
 };

 if (showOnFocus) {
 input.addEventListener("focus", () => {
 if (showAllOnFocus) {
 const opcoes = deduplicar(obterOpcoes(listId));
 renderizarOpcoes(dropdown, opcoes);
 if (opcoes.length) {
 abrirDropdown();
 }
 return;
 }
 filtrarOpcoes();
 });
 }
 input.addEventListener("input", filtrarOpcoes);
 input.addEventListener("keydown", (event) => {
 if (event.key === "Escape") {
 fecharDropdown();
 }
 });

 dropdown.addEventListener("mousedown", (event) => {
 const opcao = event.target.closest(".select-option");
 if (!opcao) return;
 event.preventDefault();
 input.value = opcao.dataset.value || opcao.textContent || "";
 input.dispatchEvent(new Event("input", { bubbles: true }));
 input.dispatchEvent(new Event("change", { bubbles: true }));
 fecharDropdown();
 });

 document.addEventListener("click", (event) => {
 if (!wrapper.contains(event.target)) {
 fecharDropdown();
 }
 });
 };

 document.querySelectorAll(".select-search").forEach((wrapper) => {
 configurarSelectSearch(wrapper);
 });

 const mapaEquipes = {{ mapa_equipes|tojson }};
 const mapaResponsaveis = {{ mapa_responsaveis|tojson }};
 const listaResponsaveis = {{ lista_responsaveis|tojson }};
 const inputCoord = document.getElementById("coordenadoria");
 const inputEquipe = document.getElementById("equipe_area");
 const datalistEquipe = document.getElementById("lista_equipe_area");
 if (mapaEquipes && Object.keys(mapaEquipes).length && inputCoord && inputEquipe && datalistEquipe) {
 const mapaEquipesNormalizado = {};
 Object.keys(mapaEquipes).forEach((chave) => {
 mapaEquipesNormalizado[normalizarTexto(chave)] = mapaEquipes[chave] || [];
 });

 const atualizarEquipes = () => {
 const chave = normalizarTexto(inputCoord.value);
 const opcoes = mapaEquipesNormalizado[chave] || [];
 datalistEquipe.innerHTML = "";
 const atual = inputEquipe.value.trim();
 const setOpcoes = new Set(opcoes);
 if (atual && !setOpcoes.has(atual)) {
 const optAtual = document.createElement("option");
 optAtual.value = atual;
 datalistEquipe.appendChild(optAtual);
 }
 opcoes.forEach((opcao) => {
 const opt = document.createElement("option");
 opt.value = opcao;
 datalistEquipe.appendChild(opt);
 });
 inputEquipe.dispatchEvent(new Event("input", { bubbles: true }));
 };

 inputCoord.addEventListener("input", atualizarEquipes);
 inputCoord.addEventListener("change", atualizarEquipes);
 atualizarEquipes();
 }

 const inputResponsavel = document.getElementById("responsavel_equipe");
 const datalistResponsavel = document.getElementById("lista_responsaveis");
 if (mapaResponsaveis && Object.keys(mapaResponsaveis).length && inputEquipe && inputResponsavel && datalistResponsavel) {
 const mapaRespNormalizado = {};
 Object.keys(mapaResponsaveis).forEach((chave) => {
 mapaRespNormalizado[normalizarTexto(chave)] = mapaResponsaveis[chave] || [];
 });

 const atualizarResponsaveis = () => {
 const chave = normalizarTexto(inputEquipe.value);
 const opcoes = chave ? (mapaRespNormalizado[chave] || []) : (listaResponsaveis || []);
 datalistResponsavel.innerHTML = "";
 const atual = inputResponsavel.value.trim();
 const setOpcoes = new Set(opcoes);
 if (atual && !setOpcoes.has(atual)) {
 const optAtual = document.createElement("option");
 optAtual.value = atual;
 datalistResponsavel.appendChild(optAtual);
 }
 opcoes.forEach((opcao) => {
 const opt = document.createElement("option");
 opt.value = opcao;
 datalistResponsavel.appendChild(opt);
 });
 inputResponsavel.dispatchEvent(new Event("input", { bubbles: true }));
 };

 inputEquipe.addEventListener("input", atualizarResponsaveis);
 inputEquipe.addEventListener("change", atualizarResponsaveis);
 atualizarResponsaveis();
 }

 const validarLista = (input) => {
 const listId = input.dataset.optionsId;
 const opcoes = deduplicar(obterOpcoes(listId));
 if (!opcoes.length) {
 input.setCustomValidity("");
 return;
 }
 const valor = normalizarTexto(input.value);
 if (!valor) {
 input.setCustomValidity("");
 return;
 }
 const valido = opcoes.some((opcao) => normalizarTexto(opcao) === valor);
 input.setCustomValidity(valido ? "" : "Selecione um valor valido da lista.");
 };

 document.querySelectorAll("input[data-validate-list=\"1\"]").forEach((input) => {
 validarLista(input);
 input.addEventListener("input", () => validarLista(input));
 input.addEventListener("change", () => validarLista(input));
 input.addEventListener("blur", () => validarLista(input));
 });

 const form = document.getElementById("processoForm");
 const modalEl = document.getElementById("modalSaidaSemSalvar");
 const btnSalvarESair = document.getElementById("btnSalvarESair");
 const btnSairSemSalvar = document.getElementById("btnSairSemSalvar");
 const redirectInput = document.getElementById("redirect_to");
 let modalSaida = null;
 let destinoSaida = "";
 let enviandoForm = false;
 let estadoInicial = "";

 const serializarFormulario = () => {
 if (!form) return "";
 const data = new FormData(form);
 const pares = [];
 data.forEach((valor, chave) => {
 pares.push(`${chave}=${String(valor)}`);
 });
 pares.sort();
 return pares.join("&");
 };

 const marcarInicial = () => {
 estadoInicial = serializarFormulario();
 };

 const formularioSujo = () => {
 if (!form) return false;
 return serializarFormulario() !== estadoInicial;
 };

 if (form) {
 const somenteVisualizacao = form.dataset.viewOnly === "1";
 if (somenteVisualizacao) {
 form.querySelectorAll("input, textarea, select").forEach((campo) => {
 if ((campo.type || "").toLowerCase() === "hidden") return;
 campo.setAttribute("disabled", "disabled");
 });
 form.querySelectorAll("button[type=\"submit\"]").forEach((botao) => {
 botao.setAttribute("disabled", "disabled");
 });
 }
 marcarInicial();
 const inputConcessionaria = form.querySelector("input[name=\"concessionaria\"]");
 const inputResponsavel = form.querySelector("input[name=\"responsavel_adm\"]");
 const scrollInput = document.getElementById("scroll_y");
 const btnSalvarEdicao = document.getElementById("btnSalvarEdicao");
 const btnVoltarGerencia = document.getElementById("btnVoltarGerencia");
 const msgSalvo = document.getElementById("msgSalvo");
 let msgSalvoTimer = null;
 const aplicarDefault = (input, fallback) => {
 if (!input) return;
 const valorDefault = (input.dataset.defaultValue || fallback || "").trim();
 if (!valorDefault) return;
 input.value = valorDefault;
 input.dispatchEvent(new Event("input", { bubbles: true }));
 input.dispatchEvent(new Event("change", { bubbles: true }));
 };
 if (inputConcessionaria) {
 inputConcessionaria.addEventListener("blur", () => {
 if (!inputConcessionaria.value.trim()) {
 aplicarDefault(inputConcessionaria, "N/A");
 }
 });
 }
 if (inputResponsavel) {
 inputResponsavel.addEventListener("blur", () => {
 if (!inputResponsavel.value.trim()) {
 aplicarDefault(inputResponsavel);
 }
 });
 }
 form.addEventListener("submit", (event) => {
 if (enviandoForm) return;
 if (scrollInput) {
 scrollInput.value = String(window.scrollY || 0);
 }
 if (inputConcessionaria && !inputConcessionaria.value.trim()) {
 aplicarDefault(inputConcessionaria, "N/A");
 }
 if (inputResponsavel && !inputResponsavel.value.trim()) {
 aplicarDefault(inputResponsavel);
 }
 enviandoForm = true;
 });

 if (btnSalvarEdicao) {
 btnSalvarEdicao.addEventListener("click", async () => {
 if (enviandoForm) return;
 if (inputConcessionaria && !inputConcessionaria.value.trim()) {
 aplicarDefault(inputConcessionaria, "N/A");
 }
 if (inputResponsavel && !inputResponsavel.value.trim()) {
 aplicarDefault(inputResponsavel);
 }
 try {
 const formData = new FormData(form);
 enviandoForm = true;
 btnSalvarEdicao.disabled = true;
 const resp = await fetch(form.action || window.location.href, {
 method: "POST",
 body: formData,
 credentials: "same-origin",
 });
 if (!resp.ok) {
 throw new Error("Falha ao salvar.");
 }
 if (btnVoltarGerencia) {
 btnVoltarGerencia.classList.remove("d-none");
 }
 if (msgSalvo) {
 msgSalvo.classList.remove("d-none");
 if (msgSalvoTimer) {
 clearTimeout(msgSalvoTimer);
 }
 msgSalvoTimer = setTimeout(() => {
 msgSalvo.classList.add("d-none");
 }, 8000);
 }
 marcarInicial();
 enviandoForm = false;
 btnSalvarEdicao.disabled = false;
 } catch (err) {
 enviandoForm = false;
 btnSalvarEdicao.disabled = false;
 form.submit();
 }
 });
 }
 if (btnVoltarGerencia) {
 btnVoltarGerencia.addEventListener("click", (event) => {
 event.preventDefault();
 enviandoForm = true;
 window.location.href = btnVoltarGerencia.getAttribute("href") || window.location.href;
 });
 }
 }

 const configurarModalSaida = () => {
 if (!modalEl) return;
 if (!window.bootstrap || !bootstrap.Modal) return;
 if (modalSaida) return;
 modalSaida = new bootstrap.Modal(modalEl);
 if (btnSalvarESair) {
 btnSalvarESair.addEventListener("click", () => {
 if (redirectInput) {
 redirectInput.value = destinoSaida || "";
 }
 enviandoForm = true;
 form?.submit();
 });
 }
 if (btnSairSemSalvar) {
 btnSairSemSalvar.addEventListener("click", () => {
 if (destinoSaida) {
 window.location.href = destinoSaida;
 } else {
 window.history.back();
 }
 });
 }
 };

 if (form && modalEl) {
 configurarModalSaida();
 window.addEventListener("load", configurarModalSaida);
 document.querySelectorAll("a[data-exit-link=\"1\"]").forEach((link) => {
 link.addEventListener("click", (event) => {
 if (!formularioSujo()) return;
 event.preventDefault();
 destinoSaida = link.getAttribute("href") || "";
 if (modalSaida) {
 modalSaida.show();
 } else if (destinoSaida) {
 window.location.href = destinoSaida;
 } else {
 window.history.back();
 }
 });
 });
 }
 window.addEventListener("beforeunload", (event) => {
 if (enviandoForm || !formularioSujo()) return;
 event.preventDefault();
 event.returnValue = "";
 });
 const autoDismissAlerts = () => {
 document.querySelectorAll(".alert[data-auto-dismiss=\"1\"]").forEach((alertEl) => {
 setTimeout(() => {
 if (alertEl.classList.contains("d-none")) return;
 if (alertEl.classList.contains("show") && window.bootstrap?.Alert) {
 const inst = bootstrap.Alert.getOrCreateInstance(alertEl);
 inst.close();
 } else {
 alertEl.classList.add("d-none");
 }
 }, 5000);
 });
 };
 autoDismissAlerts();

 const scrollInicial = Number(document.getElementById("scroll_y")?.value || 0);
 const fecharDropdowns = () => {
 document.querySelectorAll(".select-dropdown.show").forEach((dropdown) => {
 dropdown.classList.remove("show");
 });
 document.querySelectorAll("input[data-options-id]").forEach((input) => {
 input.setAttribute("aria-expanded", "false");
 });
 };
 const aplicarScroll = () => {
 if (scrollInicial > 0) {
 window.scrollTo({ top: scrollInicial, behavior: "auto" });
 }
 fecharDropdowns();
 };
 if (scrollInicial > 0) {
 requestAnimationFrame(aplicarScroll);
 setTimeout(aplicarScroll, 80);
 window.addEventListener("load", aplicarScroll);
 }
 });
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
{% if modo_edicao and not SITE_EM_CONFIGURACAO and not somente_visualizacao and pode_finalizar_gerencia %}
<script>
 const seletorTramite = document.getElementById("tramitado_para");
 const seletorDevolver = document.getElementById("devolver_para");
 const seletorDestinoSaida = document.getElementById("destino_saida");
 const wrapperDevolver = document.getElementById("devolver_wrapper");
 const botaoFinalizar = document.getElementById("botaoFinalizar");
 const botaoFinalizarSaida = document.getElementById("acao-finalizar");
 const btnDevolver = document.getElementById("btnDevolver");
 const hiddenNova = document.getElementById("nova_gerencia_hidden");
 const gerenciasComDemanda = new Set({{ (gerencias_com_demanda or [])|tojson }});
 const camposObrigatoriosFinalizar = [
  { id: "coordenadoria", label: "Coordenadoria" },
  { id: "equipe_area", label: "Equipe / &Aacute;rea" },
  { id: "responsavel_equipe", label: "Atribu&iacute;do SEI" },
  { id: "status", label: "Status" },
  { id: "tramitado_para", label: "Tramitar para" },
 ];
 const alertaObrigatoriosFinalizar = document.getElementById("alertaObrigatoriosFinalizar");
 const listaObrigatoriosFinalizar = document.getElementById("listaObrigatoriosFinalizar");
 const btnFecharObrigatorios = document.querySelector('[data-close-alert="obrigatorios"]');
 let obrigatoriosAlertado = false;
 function obterCamposObrigatoriosFinalizar() {
  const faltando = [];
  for (const campo of camposObrigatoriosFinalizar) {
   const el = document.getElementById(campo.id);
   if (!el) continue;
   if (!el.value.trim()) {
    faltando.push({ el, label: campo.label });
   }
  }
  return faltando;
 }
 function aplicarEstadoObrigatoriosFinalizar(faltando) {
  const faltandoSet = new Set(faltando.map((item) => item.el));
  for (const campo of camposObrigatoriosFinalizar) {
   const el = document.getElementById(campo.id);
   if (!el) continue;
   if (obrigatoriosAlertado && faltandoSet.has(el)) {
    el.classList.add("is-invalid");
   } else {
    el.classList.remove("is-invalid");
   }
  }
 }
 function mostrarAlertaObrigatoriosFinalizar(faltando) {
  if (!alertaObrigatoriosFinalizar || !listaObrigatoriosFinalizar) return;
  if (!faltando.length) {
   alertaObrigatoriosFinalizar.classList.add("d-none");
   listaObrigatoriosFinalizar.textContent = "";
   return;
  }
  listaObrigatoriosFinalizar.innerHTML = faltando.map((item) => item.label).join(", ");
  alertaObrigatoriosFinalizar.classList.remove("d-none");
  alertaObrigatoriosFinalizar.scrollIntoView({ behavior: "smooth", block: "center" });
 }
 function validarObrigatoriosFinalizar() {
  const faltando = obterCamposObrigatoriosFinalizar();
  aplicarEstadoObrigatoriosFinalizar(faltando);
  if (obrigatoriosAlertado) {
   mostrarAlertaObrigatoriosFinalizar(faltando);
  }
  return faltando;
 }
 function atualizarEstado() {
 if (botaoFinalizar) {
 botaoFinalizar.disabled = false;
 }
 if (botaoFinalizarSaida && seletorDestinoSaida) {
 const valorDestino = seletorDestinoSaida.value.trim();
 const vazioDestino = !valorDestino;
 const validoDestino = !seletorDestinoSaida.validity || seletorDestinoSaida.validity.valid;
 botaoFinalizarSaida.disabled = vazioDestino || !validoDestino;
 }
 if (btnDevolver && seletorDevolver && wrapperDevolver) {
 if (wrapperDevolver.classList.contains("d-none")) {
 btnDevolver.disabled = false;
 if (hiddenNova) hiddenNova.value = "";
 return;
 }
 const valorDevolver = seletorDevolver.value.trim();
 const vazioDevolver = !valorDevolver;
 const validoDevolver = !seletorDevolver.validity || seletorDevolver.validity.valid;
 btnDevolver.disabled = vazioDevolver || !validoDevolver;
 if (hiddenNova) hiddenNova.value = valorDevolver || "";
 }
 }
 if (btnFecharObrigatorios && alertaObrigatoriosFinalizar) {
  btnFecharObrigatorios.addEventListener("click", () => {
   alertaObrigatoriosFinalizar.classList.add("d-none");
  });
 }
 for (const campo of camposObrigatoriosFinalizar) {
  const el = document.getElementById(campo.id);
  if (!el) continue;
  el.addEventListener("input", () => {
   if (!obrigatoriosAlertado) return;
   validarObrigatoriosFinalizar();
  });
  el.addEventListener("change", () => {
   if (!obrigatoriosAlertado) return;
   validarObrigatoriosFinalizar();
  });
 }
 if (botaoFinalizar) {
  botaoFinalizar.addEventListener("click", (event) => {
   obrigatoriosAlertado = true;
   const faltando = validarObrigatoriosFinalizar();
   if (faltando.length) {
    event.preventDefault();
    event.stopPropagation();
   }
  });
 }
 atualizarEstado();
 if (wrapperDevolver && !wrapperDevolver.classList.contains("d-none") && seletorDevolver) {
 seletorDevolver.focus();
 }
 if (seletorTramite) {
 seletorTramite.addEventListener("input", atualizarEstado);
 seletorTramite.addEventListener("change", atualizarEstado);
 }
 if (seletorDevolver) {
 seletorDevolver.addEventListener("input", atualizarEstado);
 seletorDevolver.addEventListener("change", atualizarEstado);
 }
 if (seletorDestinoSaida) {
 seletorDestinoSaida.addEventListener("input", atualizarEstado);
 seletorDestinoSaida.addEventListener("change", atualizarEstado);
 }
 if (btnDevolver && wrapperDevolver && seletorDevolver) {
 btnDevolver.addEventListener("click", (event) => {
 if (wrapperDevolver.classList.contains("d-none")) {
 event.preventDefault();
 wrapperDevolver.classList.remove("d-none");
 seletorDevolver.focus();
 atualizarEstado();
 return;
 }
 const destino = (seletorDevolver.value || "").trim().toUpperCase();
 if (destino && gerenciasComDemanda.has(destino)) {
 event.preventDefault();
 window.alert("Já existe (ou já existiu) demanda deste processo nessa gerência. Escolha outra gerência.");
 }
 });
 }

</script>
{% endif %}
{% include "_assistente_global.html" %}
</body>

</html>






